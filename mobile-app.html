<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    
    <title>AIãƒŸã‚¹ãƒ†ãƒªãƒ¼æ•£æ­©</title>
    
    <!-- PWA ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOSç”¨ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .app-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: env(safe-area-inset-top) 20px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            background: linear-gradient(45deg, #3498DB, #2980B9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #27AE60, #229954);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #E74C3C, #C0392B);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* GPSçŠ¶æ…‹è¡¨ç¤º */
        .gps-status {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .gps-status.error {
            background: #FFEBEE;
            color: #C62828;
        }
        
        /* ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠ */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        /* è¨¼æ‹ ãƒªã‚¹ãƒˆ */
        .evidence-list {
            list-style: none;
        }
        
        .evidence-item {
            background: #F5F5F5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .evidence-item.discovered {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
        }
        
        /* æ¨ç†ãƒ•ã‚§ãƒ¼ã‚º */
        .deduction-container {
            display: none;
        }
        
        .suspect-card {
            background: white;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .suspect-card.selected {
            border-color: #3498DB;
            background: #E3F2FD;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498DB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #999;
            transition: color 0.3s;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        /* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤º */
        .offline-banner {
            background: #FFF3E0;
            color: #F57F17;
            padding: 10px;
            text-align: center;
            display: none;
        }
        
        body.offline .offline-banner {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒŠãƒ¼ -->
        <div class="offline-banner">
            ğŸ“¡ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ - ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™
        </div>
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <h1>ğŸ•µï¸ AIãƒŸã‚¹ãƒ†ãƒªãƒ¼æ•£æ­©</h1>
            <p style="font-size: 0.9em; opacity: 0.9;">ãƒªã‚¢ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰æ¨ç†ã‚²ãƒ¼ãƒ </p>
        </header>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <!-- GPSçŠ¶æ…‹ -->
            <div id="gps-status" class="gps-status">
                ğŸ“ GPSæƒ…å ±ã‚’å–å¾—ä¸­...
            </div>
            
            <!-- ã‚²ãƒ¼ãƒ é–‹å§‹ç”»é¢ -->
            <div id="start-screen" class="card">
                <h2 style="margin-bottom: 20px;">ğŸ® æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹</h2>
                <p style="margin-bottom: 20px;">ç¾åœ¨åœ°å‘¨è¾ºã®ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™</p>
                
                <div style="margin-bottom: 15px;">
                    <label>é›£æ˜“åº¦:</label>
                    <select id="difficulty" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px;">
                        <option value="easy">ç°¡å˜ï¼ˆ3åã®å®¹ç–‘è€…ï¼‰</option>
                        <option value="normal" selected>æ™®é€šï¼ˆ4-5åã®å®¹ç–‘è€…ï¼‰</option>
                        <option value="hard">é›£ã—ã„ï¼ˆ6åä»¥ä¸Šã®å®¹ç–‘è€…ï¼‰</option>
                    </select>
                </div>
                
                <button class="btn success" onclick="startNewGame()">
                    ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹
                </button>
            </div>
            
            <!-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ -->
            <div id="game-screen" style="display: none;">
                <!-- ã‚·ãƒŠãƒªã‚ªæƒ…å ± -->
                <div class="card" id="scenario-info">
                    <h3>ğŸ“– äº‹ä»¶æ¦‚è¦</h3>
                    <div id="scenario-content">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ãƒãƒƒãƒ— -->
                <div id="map"></div>
                
                <!-- è¨¼æ‹ ãƒªã‚¹ãƒˆ -->
                <div class="card">
                    <h3>ğŸ” è¨¼æ‹ ãƒªã‚¹ãƒˆ</h3>
                    <ul id="evidence-list" class="evidence-list">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </ul>
                </div>
                
                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="card">
                    <button class="btn" onclick="checkNearbyEvidence()">
                        ğŸ“ è¿‘ãã®è¨¼æ‹ ã‚’ãƒã‚§ãƒƒã‚¯
                    </button>
                </div>
            </div>
            
            <!-- æ¨ç†ãƒ•ã‚§ãƒ¼ã‚º -->
            <div id="deduction-screen" class="deduction-container">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </main>
        
        <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('game')">
                ğŸ® ã‚²ãƒ¼ãƒ 
            </div>
            <div class="nav-item" onclick="showScreen('map')">
                ğŸ—ºï¸ ãƒãƒƒãƒ—
            </div>
            <div class="nav-item" onclick="showScreen('deduction')">
                ğŸ•µï¸ æ¨ç†
            </div>
            <div class="nav-item" onclick="showScreen('profile')">
                ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
            </div>
        </nav>
    </div>
    
    <script>
        // Service Workerç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }
        
        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.textContent = 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
            installBtn.className = 'btn success';
            installBtn.style.marginBottom = '20px';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                }
            };
            document.querySelector('.main-content').prepend(installBtn);
        }
        
        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œçŸ¥
        window.addEventListener('online', () => {
            document.body.classList.remove('offline');
            updateGPSStatus('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ', false);
        });
        
        window.addEventListener('offline', () => {
            document.body.classList.add('offline');
            updateGPSStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™', true);
        });
        
        // GPSé–¢é€£
        let watchId = null;
        let currentPosition = null;
        let gameData = null;
        
        function startGPSTracking() {
            if (!navigator.geolocation) {
                updateGPSStatus('GPSéå¯¾å¿œã®ãƒ‡ãƒã‚¤ã‚¹ã§ã™', true);
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    currentPosition = position;
                    updateGPSStatus(
                        `ğŸ“ ä½ç½®æƒ…å ±å–å¾—æ¸ˆã¿ (ç²¾åº¦: ${Math.round(position.coords.accuracy)}m)`,
                        false
                    );
                    
                    if (gameData) {
                        checkEvidenceProximity(position);
                        updateDistanceDisplay(position);
                    }
                },
                error => {
                    console.error('GPS error:', error);
                    updateGPSStatus('GPSå–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
                },
                options
            );
        }
        
        function updateGPSStatus(message, isError) {
            const statusEl = document.getElementById('gps-status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'gps-status error' : 'gps-status';
        }
        
        // ã‚²ãƒ¼ãƒ é–¢é€£
        async function startNewGame() {
            if (!currentPosition) {
                alert('GPSæƒ…å ±ã‚’å–å¾—ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }
            
            const difficulty = document.getElementById('difficulty').value;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('start-screen').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚’ç”Ÿæˆä¸­...</p>
                </div>
            `;
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/game/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: 'mobile-player',
                        location: {
                            lat: currentPosition.coords.latitude,
                            lng: currentPosition.coords.longitude
                        },
                        difficulty: difficulty
                    })
                });
                
                if (response.ok) {
                    gameData = await response.json();
                    localStorage.setItem('currentGame', JSON.stringify(gameData));
                    showGameScreen();
                } else {
                    throw new Error('ã‚²ãƒ¼ãƒ é–‹å§‹å¤±æ•—');
                }
            } catch (error) {
                console.error('Game start error:', error);
                alert('ã‚²ãƒ¼ãƒ é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®å ´åˆã¯ã€ä¿å­˜æ¸ˆã¿ã‚²ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                loadOfflineGame();
            }
        }
        
        function showGameScreen() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // ã‚·ãƒŠãƒªã‚ªæƒ…å ±è¡¨ç¤ºï¼ˆæ¨ç†è¦ç´ ã‚’å¼·åŒ–ï¼‰
            if (gameData.scenario) {
                const scenario = gameData.scenario;
                document.getElementById('scenario-content').innerHTML = `
                    <h4 style="color: #667eea; margin-bottom: 10px;">${scenario.title || 'äº‹ä»¶ç™ºç”Ÿï¼'}</h4>
                    <p style="margin-bottom: 15px; line-height: 1.6;">${scenario.description || ''}</p>
                    
                    ${scenario.incident_time || scenario.discovery_time ? `
                    <div style="background: #FFEBEE; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>â° æ™‚é–“æƒ…å ±:</strong><br>
                        ${scenario.incident_time ? `<small>äº‹ä»¶ç™ºç”Ÿ: ${scenario.incident_time}</small><br>` : ''}
                        ${scenario.discovery_time ? `<small>ç™ºè¦‹æ™‚åˆ»: ${scenario.discovery_time}</small>` : ''}
                    </div>
                    ` : ''}
                    
                    ${scenario.victim ? `
                    <div style="background: #F5F5F5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>ğŸ’€ è¢«å®³è€…:</strong> ${scenario.victim.name} (${scenario.victim.age}æ­³)<br>
                        <small>${scenario.victim.occupation}</small><br>
                        ${scenario.victim.last_seen ? `<small style="color: #666;">æœ€çµ‚ç›®æ’ƒ: ${scenario.victim.last_seen}</small>` : ''}
                    </div>
                    ` : ''}
                    
                    ${scenario.suspects && scenario.suspects.length > 0 ? `
                    <div style="background: #FFF3E0; padding: 10px; border-radius: 8px;">
                        <strong>ğŸ‘¥ å®¹ç–‘è€…:</strong> ${scenario.suspects.length}å<br>
                        <small style="color: #666;">${scenario.suspects.map(s => s.name).join(', ')}</small>
                    </div>
                    ` : ''}
                    
                    <button class="btn" onclick="toggleScenarioDetails()" style="margin-top: 15px; width: 100%;">
                        å®¹ç–‘è€…ã®è©³ç´°ã‚’è¦‹ã‚‹
                    </button>
                    
                    <div id="scenario-details" style="display: none; margin-top: 15px;">
                        ${scenario.suspects ? scenario.suspects.map(suspect => `
                            <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 3px solid #667eea;">
                                <strong>${suspect.name}</strong> (${suspect.age}æ­³) - ${suspect.occupation}<br>
                                <small>é–¢ä¿‚: ${suspect.relationship}</small><br>
                                ${suspect.alibi ? `<small style="color: #1976D2;">ğŸ“ ã‚¢ãƒªãƒã‚¤: ${suspect.alibi}</small><br>` : ''}
                                ${suspect.motive ? `<small style="color: #D32F2F;">ğŸ’­ å‹•æ©Ÿ: ${suspect.motive}</small><br>` : ''}
                                ${suspect.suspicious_point ? `<small style="color: #F57C00;">âš ï¸ ä¸å¯©ãªç‚¹: ${suspect.suspicious_point}</small>` : ''}
                            </div>
                        `).join('') : ''}
                    </div>
                    
                    ${scenario.timeline && scenario.timeline.length > 0 ? `
                    <button class="btn" onclick="toggleTimeline()" style="margin-top: 10px; width: 100%;">
                        ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¦‹ã‚‹
                    </button>
                    
                    <div id="timeline-details" style="display: none; margin-top: 15px; background: #E3F2FD; padding: 15px; border-radius: 8px;">
                        <strong>ğŸ“… äº‹ä»¶ã®æ™‚ç³»åˆ—:</strong><br>
                        ${scenario.timeline.map(event => `
                            <small style="display: block; margin: 5px 0; padding-left: 20px;">â€¢ ${event}</small>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
            }
            
            // è¨¼æ‹ ãƒªã‚¹ãƒˆè¡¨ç¤º
            const evidenceList = document.getElementById('evidence-list');
            evidenceList.innerHTML = gameData.evidence.map(ev => `
                <li class="evidence-item" id="evidence-${ev.evidence_id}">
                    <div>
                        <strong>${ev.name}</strong><br>
                        <small>ğŸ“ ${ev.poi_name}</small>
                    </div>
                    <span id="distance-${ev.evidence_id}">--m</span>
                </li>
            `).join('');
            
            // ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            initMap();
            
            // GPSæƒ…å ±ãŒã‚ã‚Œã°è·é›¢ã‚’æ›´æ–°
            if (currentPosition) {
                updateDistanceDisplay(currentPosition);
            }
        }
        
        function initMap() {
            // å®Ÿéš›ã«ã¯Google Maps APIã‚„Leafletã‚’ä½¿ç”¨
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = `
                <div style="padding: 20px; text-align: center; background: #E3F2FD;">
                    <h3>ğŸ—ºï¸ ãƒãƒƒãƒ—</h3>
                    <p>ç¾åœ¨åœ°ã¨è¨¼æ‹ ã®ä½ç½®ã‚’è¡¨ç¤º</p>
                    <p style="margin-top: 10px;">
                        ç·¯åº¦: ${currentPosition.coords.latitude.toFixed(4)}<br>
                        çµŒåº¦: ${currentPosition.coords.longitude.toFixed(4)}
                    </p>
                </div>
            `;
        }
        
        async function checkNearbyEvidence() {
            if (!currentPosition || !gameData) {
                alert('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯GPSæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // å„è¨¼æ‹ ã¨ã®è·é›¢ã‚’è¨ˆç®—
            for (const evidence of gameData.evidence) {
                const distance = calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    evidence.location.lat,
                    evidence.location.lng
                );
                
                document.getElementById(`distance-${evidence.evidence_id}`).textContent = `${Math.round(distance)}m`;
                
                // 50mä»¥å†…ãªã‚‰ç™ºè¦‹å¯èƒ½
                if (distance <= 50) {
                    discoverEvidence(evidence);
                }
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        async function discoverEvidence(evidence) {
            const evidenceItem = document.getElementById(`evidence-${evidence.evidence_id}`);
            if (evidenceItem.classList.contains('discovered')) {
                return; // æ—¢ã«ç™ºè¦‹æ¸ˆã¿
            }
            
            // ç™ºè¦‹é€šçŸ¥
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // è©³ç´°ãªè¨¼æ‹ æƒ…å ±ã‚’è¡¨ç¤º
            const evidenceDetails = `
ğŸ‰ è¨¼æ‹ ã‚’ç™ºè¦‹ï¼

ğŸ“ å ´æ‰€: ${evidence.poi_name}
ğŸ” è¨¼æ‹ : ${evidence.name}

ğŸ“ è©³ç´°:
${evidence.description || 'è©³ç´°ãªåˆ†æãŒå¿…è¦ã§ã™ã€‚'}

ğŸ’¡ ãƒ’ãƒ³ãƒˆ:
${evidence.hint || 'ã“ã®è¨¼æ‹ ã®æ„å‘³ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚'}

é‡è¦åº¦: ${evidence.importance === 'critical' ? 'â­â­â­ é‡è¦' : 'â­â­ æ™®é€š'}
            `;
            
            alert(evidenceDetails);
            evidenceItem.classList.add('discovered');
            
            // ã‚µãƒ¼ãƒãƒ¼ã«ç™ºè¦‹ã‚’å ±å‘Š
            try {
                await fetch('http://localhost:8080/api/v1/evidence/discover', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        game_id: gameData.game_id,
                        player_id: 'mobile-player',
                        current_location: {
                            lat: currentPosition.coords.latitude,
                            lng: currentPosition.coords.longitude
                        },
                        evidence_id: evidence.evidence_id
                    })
                });
            } catch (error) {
                console.error('Evidence discovery error:', error);
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ç™ºè¦‹ã‚’è¨˜éŒ²
                saveOfflineDiscovery(evidence.evidence_id);
            }
            
            // ã™ã¹ã¦ã®è¨¼æ‹ ã‚’ç™ºè¦‹ã—ãŸã‹ç¢ºèª
            checkAllEvidenceFound();
        }
        
        function checkAllEvidenceFound() {
            const allEvidence = document.querySelectorAll('.evidence-item');
            const discoveredEvidence = document.querySelectorAll('.evidence-item.discovered');
            
            if (allEvidence.length === discoveredEvidence.length) {
                alert('ğŸ‰ ã™ã¹ã¦ã®è¨¼æ‹ ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼\næ¨ç†ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã¿ã¾ã™ã€‚');
                showDeductionPhase();
            }
        }
        
        async function showDeductionPhase() {
            // æ¨ç†ãƒ•ã‚§ãƒ¼ã‚ºã®UIã‚’è¡¨ç¤º
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('deduction-screen').style.display = 'block';
            
            // å®¹ç–‘è€…æƒ…å ±ã‚’å–å¾—
            const suspects = gameData.scenario.suspects || [];
            let questionsRemaining = 10;
            
            document.getElementById('deduction-screen').innerHTML = `
                <div class="card">
                    <h2>ğŸ•µï¸ æ¨ç†ãƒ•ã‚§ãƒ¼ã‚º</h2>
                    <p>è¨¼æ‹ ã‚’é›†ã‚çµ‚ã‚ã‚Šã¾ã—ãŸï¼å®¹ç–‘è€…ã«è³ªå•ã—ã¦çœŸçŠ¯äººã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã—ã‚‡ã†ã€‚</p>
                    <p style="color: #666; font-size: 0.9em;">æ®‹ã‚Šè³ªå•å›æ•°: <span id="questions-remaining">${questionsRemaining}</span>å›</p>
                </div>
                
                <div class="card">
                    <h3>ğŸ‘¥ å®¹ç–‘è€…ãƒªã‚¹ãƒˆ</h3>
                    <div id="suspects-list">
                        ${suspects.map(suspect => `
                            <div class="suspect-card" onclick="selectSuspect('${suspect.name}')">
                                <h4>${suspect.name} (${suspect.age}æ­³)</h4>
                                <p><strong>è·æ¥­:</strong> ${suspect.occupation}</p>
                                <p><strong>é–¢ä¿‚:</strong> ${suspect.relationship}</p>
                                <p><strong>ã‚¢ãƒªãƒã‚¤:</strong> ${suspect.alibi}</p>
                                <p><strong>å‹•æ©Ÿ:</strong> ${suspect.motive}</p>
                                ${suspect.suspicious_point ? `<p style="color: #F57C00;"><strong>ç–‘å•ç‚¹:</strong> ${suspect.suspicious_point}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="card" id="question-section" style="display: none;">
                    <h3>ğŸ” å®¹ç–‘è€…ã¸ã®è³ªå•</h3>
                    <p><strong>é¸æŠä¸­:</strong> <span id="selected-suspect"></span></p>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">è³ªå•ã‚¿ã‚¤ãƒ—:</label>
                        <select id="question-type" style="width: 100%; padding: 10px; margin-top: 5px;">
                            <option value="alibi">ã‚¢ãƒªãƒã‚¤ã«ã¤ã„ã¦è©³ã—ã</option>
                            <option value="motive">å‹•æ©Ÿã«ã¤ã„ã¦</option>
                            <option value="relationship">è¢«å®³è€…ã¨ã®é–¢ä¿‚</option>
                            <option value="witness">ä»–ã®äººã«ã¤ã„ã¦</option>
                            <option value="behavior">äº‹ä»¶å½“æ—¥ã®è¡Œå‹•</option>
                            <option value="evidence">è¨¼æ‹ ã«ã¤ã„ã¦</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="askSuspectQuestion()" style="width: 100%;">
                        è³ªå•ã™ã‚‹
                    </button>
                </div>
                
                <div class="card">
                    <h3>ğŸ’¬ è³ªå•å±¥æ­´</h3>
                    <div id="conversation-log" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #666; font-style: italic;">ã¾ã è³ªå•ã—ã¦ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ¯ çŠ¯äººã‚’ç‰¹å®š</h3>
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">çœŸçŠ¯äººã¯èª°ã§ã™ã‹ï¼Ÿ</label>
                        <select id="culprit-guess" style="width: 100%; padding: 10px; margin-top: 5px;">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
                            ${suspects.map(suspect => `
                                <option value="${suspect.name}">${suspect.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">æ¨ç†ã®æ ¹æ‹ ã‚’èª¬æ˜ã—ã¦ãã ã•ã„:</label>
                        <textarea id="deduction-reasoning" style="width: 100%; height: 100px; padding: 10px; margin-top: 5px;" 
                            placeholder="è¨¼æ‹ ã¨è³ªå•ã‹ã‚‰å¾—ãŸæƒ…å ±ã‚’åŸºã«ã€ãªãœã“ã®äººãŒçŠ¯äººã ã¨æ€ã†ã‹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    
                    <button class="btn success" onclick="submitFinalDeduction()" style="width: 100%;">
                        æ¨ç†ã‚’æå‡ºã™ã‚‹
                    </button>
                </div>
                
                <div id="deduction-result" style="display: none;">
                    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                </div>
            `;
        }
        
        function showScreen(screen) {
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function loadOfflineGame() {
            const savedGame = localStorage.getItem('currentGame');
            if (savedGame) {
                gameData = JSON.parse(savedGame);
                showGameScreen();
            }
        }
        
        function saveOfflineDiscovery(evidenceId) {
            const discoveries = JSON.parse(localStorage.getItem('discoveries') || '[]');
            discoveries.push({
                evidence_id: evidenceId,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('discoveries', JSON.stringify(discoveries));
        }
        
        function checkEvidenceProximity(position) {
            // è‡ªå‹•çš„ã«è¿‘ãã®è¨¼æ‹ ã‚’ãƒã‚§ãƒƒã‚¯
            if (gameData && gameData.evidence) {
                for (const evidence of gameData.evidence) {
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    );
                    
                    if (distance <= 30) {
                        // 30mä»¥å†…ã«ãªã£ãŸã‚‰é€šçŸ¥
                        showProximityNotification(evidence, distance);
                    }
                }
            }
        }
        
        function updateDistanceDisplay(position) {
            // å„è¨¼æ‹ ã¨ã®è·é›¢ã‚’è¡¨ç¤ºæ›´æ–°
            if (gameData && gameData.evidence) {
                for (const evidence of gameData.evidence) {
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    );
                    
                    const distanceElement = document.getElementById(`distance-${evidence.evidence_id}`);
                    if (distanceElement) {
                        distanceElement.textContent = `${Math.round(distance)}m`;
                    }
                }
            }
        }
        
        function showProximityNotification(evidence, distance) {
            if (Notification.permission === 'granted') {
                new Notification('è¨¼æ‹ ãŒè¿‘ãã«ã‚ã‚Šã¾ã™ï¼', {
                    body: `${evidence.name}ã¾ã§ç´„${Math.round(distance)}m`,
                    icon: '/static/icons/icon-192x192.png',
                    vibrate: [200, 100, 200]
                });
            }
        }
        
        function toggleScenarioDetails() {
            const details = document.getElementById('scenario-details');
            const button = event.target;
            if (details.style.display === 'none') {
                details.style.display = 'block';
                button.textContent = 'å®¹ç–‘è€…ã®è©³ç´°ã‚’éš ã™';
            } else {
                details.style.display = 'none';
                button.textContent = 'å®¹ç–‘è€…ã®è©³ç´°ã‚’è¦‹ã‚‹';
            }
        }
        
        function toggleTimeline() {
            const timeline = document.getElementById('timeline-details');
            const button = event.target;
            if (timeline.style.display === 'none') {
                timeline.style.display = 'block';
                button.textContent = 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éš ã™';
            } else {
                timeline.style.display = 'none';
                button.textContent = 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¦‹ã‚‹';
            }
        }
        
        // æ¨ç†ãƒ•ã‚§ãƒ¼ã‚ºã®æ©Ÿèƒ½
        let selectedSuspectName = null;
        let questionsAsked = 0;
        const maxQuestions = 10;
        
        function selectSuspect(suspectName) {
            selectedSuspectName = suspectName;
            document.getElementById('selected-suspect').textContent = suspectName;
            document.getElementById('question-section').style.display = 'block';
            
            // é¸æŠã•ã‚ŒãŸå®¹ç–‘è€…ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.suspect-card').forEach(card => {
                card.style.border = '2px solid #E0E0E0';
            });
            event.target.style.border = '2px solid #667eea';
        }
        
        async function askSuspectQuestion() {
            if (!selectedSuspectName) {
                alert('å®¹ç–‘è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (questionsAsked >= maxQuestions) {
                alert('è³ªå•å›æ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ');
                return;
            }
            
            const questionType = document.getElementById('question-type').value;
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/deduction/question', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        game_id: gameData.game_id,
                        suspect_name: selectedSuspectName,
                        question_type: questionType
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayQuestionResult(result);
                    questionsAsked++;
                    document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
                } else {
                    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒãªã„å ´åˆã®ç°¡æ˜“å›ç­”ç”Ÿæˆ
                    const mockAnswer = generateMockAnswer(selectedSuspectName, questionType);
                    displayQuestionResult(mockAnswer);
                    questionsAsked++;
                    document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
                }
            } catch (error) {
                console.error('Question error:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç°¡æ˜“å›ç­”ã‚’ç”Ÿæˆ
                const mockAnswer = generateMockAnswer(selectedSuspectName, questionType);
                displayQuestionResult(mockAnswer);
                questionsAsked++;
                document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
            }
        }
        
        function generateMockAnswer(suspectName, questionType) {
            const suspect = gameData.scenario.suspects.find(s => s.name === suspectName);
            const isCulprit = suspect.name === gameData.scenario.culprit;
            
            let answer = '';
            let reaction = '';
            
            switch (questionType) {
                case 'alibi':
                    answer = suspect.alibi || 'ç‰¹ã«ã‚¢ãƒªãƒã‚¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                    reaction = isCulprit ? 'å°‘ã—ç·Šå¼µã—ãŸæ§˜å­ã§ç­”ãˆã‚‹ã€‚' : 'è½ã¡ç€ã„ã¦ç­”ãˆã‚‹ã€‚';
                    break;
                case 'motive':
                    answer = suspect.motive ? `${suspect.motive}ã§ã™ãŒã€æ®ºå®³ã™ã‚‹ã»ã©ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚` : 'ç‰¹ã«å‹•æ©Ÿã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                    reaction = isCulprit ? 'è¡¨æƒ…ãŒå¼·å¼µã‚‹ã€‚' : 'ç‡ç›´ã«ç­”ãˆã‚‹ã€‚';
                    break;
                case 'relationship':
                    answer = `è¢«å®³è€…ã¨ã¯${suspect.relationship}ã®é–¢ä¿‚ã§ã—ãŸã€‚`;
                    reaction = isCulprit ? 'ç›®ã‚’é€¸ã‚‰ã—ãŒã¡ã«ãªã‚‹ã€‚' : 'æ™®é€šã«ç­”ãˆã‚‹ã€‚';
                    break;
                case 'behavior':
                    answer = isCulprit && suspect.contradiction ? 
                        suspect.contradiction : 
                        'ã„ã¤ã‚‚é€šã‚Šã®æ—¥å¸¸ã‚’éã”ã—ã¦ã„ã¾ã—ãŸã€‚';
                    reaction = isCulprit ? 'è©³ç´°ã‚’é¿ã‘ãŸãŒã‚‹ã€‚' : 'ã¯ã£ãã‚Šã¨ç­”ãˆã‚‹ã€‚';
                    break;
                default:
                    answer = 'ç‰¹ã«ãŠç­”ãˆã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                    reaction = 'å›°ã£ãŸè¡¨æƒ…ã‚’è¦‹ã›ã‚‹ã€‚';
            }
            
            return {
                question: `${questionType}ã«ã¤ã„ã¦è³ªå•ã—ã¾ã—ãŸ`,
                answer: answer,
                reaction: reaction,
                suspect_name: suspectName,
                hint_revealed: isCulprit && Math.random() > 0.7 ? suspect.contradiction || 'ä½•ã‹ã‚’éš ã—ã¦ã„ã‚‹æ§˜å­' : null
            };
        }
        
        function displayQuestionResult(result) {
            const logDiv = document.getElementById('conversation-log');
            if (logDiv.innerHTML.includes('ã¾ã è³ªå•ã—ã¦ã„ã¾ã›ã‚“')) {
                logDiv.innerHTML = '';
            }
            
            const conversationHTML = `
                <div style="background: #E8F5E9; padding: 10px; margin: 10px 0; border-radius: 8px;">
                    <p><strong>ğŸ” è³ªå•:</strong> ${result.suspect_name}ã«${result.question}</p>
                </div>
                <div style="background: #FFF3E0; padding: 10px; margin: 10px 0; border-radius: 8px;">
                    <p><strong>ğŸ‘¤ ${result.suspect_name}:</strong></p>
                    <p>${result.answer}</p>
                    <p style="font-style: italic; color: #666; margin-top: 8px;">${result.reaction}</p>
                    ${result.hint_revealed ? `<p style="color: #2E7D32; margin-top: 8px;">ğŸ’¡ æ°—ã¥ã„ãŸç‚¹: ${result.hint_revealed}</p>` : ''}
                </div>
            `;
            logDiv.innerHTML = conversationHTML + logDiv.innerHTML;
        }
        
        async function submitFinalDeduction() {
            const culpritGuess = document.getElementById('culprit-guess').value;
            const reasoning = document.getElementById('deduction-reasoning').value;
            
            if (!culpritGuess || !reasoning) {
                alert('çŠ¯äººã®é¸æŠã¨æ¨ç†ã®æ ¹æ‹ ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ­£è§£åˆ¤å®š
            const isCorrect = culpritGuess === gameData.scenario.culprit;
            const trueCulprit = gameData.scenario.culprit;
            const trueMotive = gameData.scenario.true_motive;
            
            // çµæœè¡¨ç¤º
            document.getElementById('deduction-result').style.display = 'block';
            document.getElementById('deduction-result').innerHTML = `
                <div class="card" style="background: ${isCorrect ? '#E8F5E9' : '#FFEBEE'};">
                    <h3 style="color: ${isCorrect ? '#2E7D32' : '#C62828'};">
                        ${isCorrect ? 'ğŸ‰ æ­£è§£ï¼' : 'ğŸ˜” ä¸æ­£è§£...'}
                    </h3>
                    
                    <div style="margin: 20px 0;">
                        <p><strong>ã‚ãªãŸã®æ¨ç†:</strong> ${culpritGuess}</p>
                        <p><strong>æ­£è§£:</strong> ${trueCulprit}</p>
                        <p style="margin-top: 10px;"><strong>ã‚ãªãŸã®æ¨ç†æ ¹æ‹ :</strong></p>
                        <p style="background: #F5F5F5; padding: 10px; border-radius: 5px;">${reasoning}</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4>ğŸ“– äº‹ä»¶ã®çœŸç›¸</h4>
                        <p><strong>çœŸçŠ¯äºº:</strong> ${trueCulprit}</p>
                        <p><strong>çœŸã®å‹•æ©Ÿ:</strong> ${trueMotive}</p>
                        <p><strong>çŠ¯è¡Œæ–¹æ³•:</strong> ${gameData.scenario.method}</p>
                        ${gameData.scenario.trick ? `<p><strong>ãƒˆãƒªãƒƒã‚¯:</strong> ${gameData.scenario.trick}</p>` : ''}
                    </div>
                    
                    <div style="background: #E3F2FD; padding: 15px; border-radius: 8px;">
                        <h4>ğŸ† çµæœ</h4>
                        <p>è³ªå•å›æ•°: ${questionsAsked}/${maxQuestions}å›ä½¿ç”¨</p>
                        <p>è¨¼æ‹ ç™ºè¦‹: ${document.querySelectorAll('.evidence-item.discovered').length}/${document.querySelectorAll('.evidence-item').length}å€‹</p>
                        ${isCorrect ? 
                            `<p style="color: #2E7D32; font-weight: bold;">ğŸŠ äº‹ä»¶è§£æ±ºï¼ç´ æ™´ã‚‰ã—ã„æ¨ç†ã§ã—ãŸï¼</p>` : 
                            `<p style="color: #D32F2F;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚è¨¼æ‹ ã¨è¨¼è¨€ã‚’ã‚ˆãæ¤œè¨¼ã—ã¦ãã ã•ã„ã€‚</p>`
                        }
                    </div>
                    
                    <button class="btn" onclick="location.reload()" style="margin-top: 20px; width: 100%;">
                        æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
                    </button>
                </div>
            `;
            
            // çµæœã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('deduction-result').scrollIntoView({ behavior: 'smooth' });
        }
        
        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            startGPSTracking();
            
            // é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ä¿å­˜æ¸ˆã¿ã‚²ãƒ¼ãƒ ãŒã‚ã‚‹ã‹ç¢ºèª
            const savedGame = localStorage.getItem('currentGame');
            if (savedGame) {
                if (confirm('å‰å›ã®ã‚²ãƒ¼ãƒ ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ')) {
                    loadOfflineGame();
                }
            }
        });
    </script>
</body>
</html>