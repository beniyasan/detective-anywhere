<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    
    <title>Walking Mystery</title>
    
    <!-- PWA ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOSç”¨ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Leaflet Routing Machine for real road routing -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .app-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: env(safe-area-inset-top) 20px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            padding: 20px;
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }
        
        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            background: linear-gradient(45deg, #3498DB, #2980B9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #27AE60, #229954);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #E74C3C, #C0392B);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* GPSçŠ¶æ…‹è¡¨ç¤º */
        .gps-status {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .gps-status.error {
            background: #FFEBEE;
            color: #C62828;
        }
        
        /* ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠ */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        /* è¨¼æ‹ ãƒªã‚¹ãƒˆ */
        .evidence-list {
            list-style: none;
        }
        
        .evidence-item {
            background: #F5F5F5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .evidence-item.discovered {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
        }
        
        /* æ¨ç†ãƒ•ã‚§ãƒ¼ã‚º */
        .deduction-container {
            display: none;
        }
        
        .suspect-card {
            background: white;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .suspect-card.selected {
            border-color: #3498DB;
            background: #E3F2FD;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498DB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #999;
            transition: color 0.3s;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        /* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤º */
        .offline-banner {
            background: #FFF3E0;
            color: #F57F17;
            padding: 10px;
            text-align: center;
            display: none;
        }
        
        body.offline .offline-banner {
            display: block;
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã®ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é‡ãªã‚Šå¯¾ç­– */
        #start-screen, #game-screen, #deduction-screen {
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }
        
        /* ã‚²ãƒ¼ãƒ ç”»é¢å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚‚è¿½åŠ ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        #scenario-content, #evidence-section, #deduction-container {
            margin-bottom: 20px;
        }
        
        /* ãƒœã‚¿ãƒ³ãŒä¸‹éƒ¨ã«é…ç½®ã•ã‚Œã‚‹å ´åˆã®è¿½åŠ ãƒãƒ¼ã‚¸ãƒ³ */
        .btn:last-child, .start-btn:last-child, .secondary-btn:last-child {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒŠãƒ¼ -->
        <div class="offline-banner">
            ğŸ“¡ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ - ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™
        </div>
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <h1 style="display: flex; align-items: center; gap: 10px;">
                <img src="/static/detective-icon.jpg" alt="Detective" style="width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                Walking Mystery
            </h1>
            <p style="font-size: 0.9em; opacity: 0.9;">ãŠæ•£æ­©æ¨ç†ã‚²ãƒ¼ãƒ </p>
        </header>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <!-- GPSçŠ¶æ…‹ -->
            <div id="gps-status" class="gps-status">
                ğŸ“ GPSæƒ…å ±ã‚’å–å¾—ä¸­...
            </div>
            
            <!-- ã‚²ãƒ¼ãƒ é–‹å§‹ç”»é¢ -->
            <div id="start-screen" class="card">
                <h2 style="margin-bottom: 20px;">ğŸ® æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹</h2>
                <p style="margin-bottom: 20px;">ç¾åœ¨åœ°å‘¨è¾ºã®ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™</p>
                
                <div style="margin-bottom: 15px;">
                    <label>é›£æ˜“åº¦:</label>
                    <select id="difficulty" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px;">
                        <option value="easy">ç°¡å˜ï¼ˆ3åã®å®¹ç–‘è€…ï¼‰</option>
                        <option value="normal" selected>æ™®é€šï¼ˆ4-5åã®å®¹ç–‘è€…ï¼‰</option>
                        <option value="hard">é›£ã—ã„ï¼ˆ6åä»¥ä¸Šã®å®¹ç–‘è€…ï¼‰</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>è¨¼æ‹ ã®æ¤œç´¢ç¯„å›²:</label>
                    <select id="radius" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px;">
                        <option value="200">200mï¼ˆå¾’æ­©3åˆ†åœå†…ï¼‰</option>
                        <option value="500">500mï¼ˆå¾’æ­©7åˆ†åœå†…ï¼‰</option>
                        <option value="1000" selected>1kmï¼ˆå¾’æ­©15åˆ†åœå†…ï¼‰</option>
                        <option value="2000">2kmï¼ˆå¾’æ­©30åˆ†åœå†…ï¼‰</option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        ç‹­ã„ã»ã©é›†ä¸­çš„ã€åºƒã„ã»ã©åºƒç¯„å›²ã®æ¢ç´¢ã«ãªã‚Šã¾ã™
                    </small>
                </div>
                
                <button class="btn success" onclick="startNewGame()">
                    ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹
                </button>
            </div>
            
            <!-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ -->
            <div id="game-screen" style="display: none;">
                <!-- ã‚·ãƒŠãƒªã‚ªæƒ…å ± -->
                <div class="card" id="scenario-info">
                    <h3>ğŸ“– äº‹ä»¶æ¦‚è¦</h3>
                    <div id="scenario-content">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ãƒãƒƒãƒ— -->
                <div id="map"></div>
                
                <!-- è¨¼æ‹ ãƒªã‚¹ãƒˆ -->
                <div class="card">
                    <h3>ğŸ” è¨¼æ‹ ãƒªã‚¹ãƒˆ</h3>
                    <ul id="evidence-list" class="evidence-list">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </ul>
                </div>
                
                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="card">
                    <button class="btn" onclick="checkNearbyEvidence()">
                        ğŸ“ è¿‘ãã®è¨¼æ‹ ã‚’ãƒã‚§ãƒƒã‚¯
                    </button>
                    <button class="btn" onclick="toggleRecommendedRoute()" style="margin-top: 10px; background: linear-gradient(45deg, #667eea, #764ba2);">
                        ğŸ—ºï¸ å¾ªç’°ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºåˆ‡æ›¿
                    </button>
                    <button class="btn" onclick="toggleWalkingDirections()" style="margin-top: 10px; background: linear-gradient(45deg, #27AE60, #229954);">
                        ğŸš¶ è©³ç´°ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                    </button>
                </div>
            </div>
            
            <!-- æ¨ç†ãƒ•ã‚§ãƒ¼ã‚º -->
            <div id="deduction-screen" class="deduction-container">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <!-- ãƒãƒƒãƒ—ç”»é¢ -->
            <div id="map-screen" style="display: none;">
                <div class="card">
                    <h3>ğŸ—ºï¸ ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒãƒƒãƒ—</h3>
                    <div id="fullscreen-map" style="width: 100%; height: 60vh; border-radius: 15px; overflow: hidden;"></div>
                </div>
                
                <div class="card">
                    <h4>ğŸ“ ç¾åœ¨ã®çŠ¶æ³</h4>
                    <div id="map-game-status">
                        <p>ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
                
                <div class="card" id="map-evidence-list" style="display: none;">
                    <h4>ğŸ” è¨¼æ‹ ãƒªã‚¹ãƒˆ</h4>
                    <div id="map-evidence-content">
                        <!-- è¨¼æ‹ æƒ…å ±ã‚’è¡¨ç¤º -->
                    </div>
                </div>
            </div>
            
            <!-- æ¨ç†ã‚¿ãƒ–ç”»é¢ -->
            <div id="deduction-tab-screen" style="display: none;">
                <div class="card">
                    <h3>ğŸ•µï¸ æ¨ç†ãƒãƒ¼ãƒˆ</h3>
                    <p>ã‚²ãƒ¼ãƒ é€²è¡Œä¸­ã«ãƒ¡ãƒ¢ã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™</p>
                    <textarea id="deduction-notes" style="width: 100%; height: 200px; padding: 10px; border-radius: 5px; border: 1px solid #ddd;" placeholder="æ¨ç†ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div class="card" id="current-game-info" style="display: none;">
                    <h4>ğŸ“– ç¾åœ¨ã®ã‚²ãƒ¼ãƒ æƒ…å ±</h4>
                    <div id="game-info-content">
                        <!-- ã‚²ãƒ¼ãƒ æƒ…å ±ã‚’è¡¨ç¤º -->
                    </div>
                </div>
            </div>
            
            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ -->
            <div id="profile-screen" style="display: none;">
                <div class="card">
                    <h3>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                    <p>å°†æ¥å®Ÿè£…äºˆå®šã®æ©Ÿèƒ½ã§ã™</p>
                    
                    <div style="background: #F5F5F5; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4>ğŸš§ å®Ÿè£…äºˆå®šæ©Ÿèƒ½</h4>
                        <ul style="margin: 10px 0 0 20px;">
                            <li>ãƒ—ãƒ¬ã‚¤çµ±è¨ˆï¼ˆè§£æ±ºäº‹ä»¶æ•°ã€æ¨ç†ç²¾åº¦ãªã©ï¼‰</li>
                            <li>ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒƒã‚¸ã‚·ã‚¹ãƒ†ãƒ </li>
                            <li>è¨­å®šã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</li>
                            <li>ã‚²ãƒ¼ãƒ å±¥æ­´</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('game')">
                ğŸ® ã‚²ãƒ¼ãƒ 
            </div>
            <div class="nav-item" onclick="showScreen('map')">
                ğŸ—ºï¸ ãƒãƒƒãƒ—
            </div>
            <div class="nav-item" onclick="showScreen('deduction')">
                ğŸ•µï¸ æ¨ç†
            </div>
            <div class="nav-item" onclick="showScreen('profile')">
                ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
            </div>
        </nav>
    </div>
    
    <script>
        // Service Workerç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }
        
        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.textContent = 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
            installBtn.className = 'btn success';
            installBtn.style.marginBottom = '20px';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                }
            };
            document.querySelector('.main-content').prepend(installBtn);
        }
        
        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œçŸ¥
        window.addEventListener('online', () => {
            document.body.classList.remove('offline');
            updateGPSStatus('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ', false);
        });
        
        window.addEventListener('offline', () => {
            document.body.classList.add('offline');
            updateGPSStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™', true);
        });
        
        // APIè¨­å®š
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000' 
            : 'https://detective-anywhere-689953252523.asia-northeast1.run.app';
        
        // å…±é€šã®fetché–¢æ•°ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
        async function fetchWithTimeout(url, options = {}, timeoutMs = 120000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }
        
        // GPSé–¢é€£
        let watchId = null;
        let currentPosition = null;
        let gameData = null;
        
        // åœ°å›³é–¢é€£
        let gameMap = null;
        let fullscreenMap = null;
        let playerMarker = null;
        let fullscreenPlayerMarker = null;
        let evidenceMarkers = [];
        let fullscreenEvidenceMarkers = [];
        let routeLines = [];
        let recommendedRoute = null;
        let routingControl = null;
        
        function startGPSTracking() {
            if (!navigator.geolocation) {
                updateGPSStatus('GPSéå¯¾å¿œã®ãƒ‡ãƒã‚¤ã‚¹ã§ã™', true);
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    currentPosition = position;
                    updateGPSStatus(
                        `ğŸ“ ä½ç½®æƒ…å ±å–å¾—æ¸ˆã¿ (ç²¾åº¦: ${Math.round(position.coords.accuracy)}m)`,
                        false
                    );
                    
                    if (gameData) {
                        checkEvidenceProximity(position);
                        updateDistanceDisplay(position);
                        updatePlayerLocationOnMap(position);
                    }
                },
                error => {
                    console.error('GPS error:', error);
                    updateGPSStatus('GPSå–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
                },
                options
            );
        }
        
        function updateGPSStatus(message, isError) {
            const statusEl = document.getElementById('gps-status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'gps-status error' : 'gps-status';
        }
        
        // ã‚²ãƒ¼ãƒ é–¢é€£
        async function startNewGame() {
            // GPSæƒ…å ±ãŒãªã„å ´åˆã¯æ±äº¬é§…ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã¨ã—ã¦ä½¿ç”¨
            if (!currentPosition) {
                currentPosition = {
                    coords: {
                        latitude: 35.6812,
                        longitude: 139.7671,
                        accuracy: 100
                    }
                };
                updateGPSStatus('ğŸ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬é§…ï¼‰ã‚’ä½¿ç”¨ä¸­', false);
            }
            
            const difficulty = document.getElementById('difficulty').value;
            const radius = parseInt(document.getElementById('radius').value);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('start-screen').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>AIæ¨ç†ã‚·ãƒŠãƒªã‚ªã‚’ç”Ÿæˆä¸­...</p>
                    <small style="color: #666; margin-top: 10px; display: block;">
                        æ¤œç´¢ç¯„å›²: ${radius}m / é›£æ˜“åº¦: ${difficulty}
                    </small>
                </div>
            `;
            
            try {
                // ã¾ãšã‚µãƒ¼ãƒãƒ¼ã‚’ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
                console.log('Warming up server...');
                try {
                    await fetchWithTimeout(`${API_BASE_URL}/warmup`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    }, 10000);
                    console.log('Server warmup completed');
                } catch (warmupError) {
                    console.log('Warmup failed, continuing anyway:', warmupError);
                }
                
                // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’ç”Ÿæˆ
                const playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetchWithTimeout(`${API_BASE_URL}/api/v1/game/start-progressive`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: playerId,
                        location: {
                            lat: currentPosition.coords.latitude,
                            lng: currentPosition.coords.longitude
                        },
                        difficulty: difficulty,
                        radius: radius
                    })
                }, 120000);
                
                console.log('Response status:', response.status, 'OK:', response.ok);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Game data received:', result);
                    
                    // å³åº§ç‰ˆã¯å®Œæˆã•ã‚ŒãŸã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥è¿”ã™
                    gameData = result;
                    gameData.player_id = playerId;
                    localStorage.setItem('currentGame', JSON.stringify(gameData));
                    showGameScreen();
                } else {
                    const errorData = await response.text();
                    console.error('Server error response:', errorData);
                    throw new Error(`ã‚²ãƒ¼ãƒ é–‹å§‹å¤±æ•— (HTTP ${response.status}): ${errorData}`);
                }
            } catch (error) {
                console.error('Game start error:', error);
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’åœæ­¢ã—ã¦å…ƒã®ç”»é¢ã«æˆ»ã™
                document.getElementById('start-screen').innerHTML = `
                    <h1 style="display: flex; align-items: center; gap: 10px;">
                <img src="/static/detective-icon.jpg" alt="Detective" style="width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                Walking Mystery
            </h1>
                    <p>ãŠæ•£æ­©ã—ãªãŒã‚‰æ¨ç†ã‚²ãƒ¼ãƒ ã‚’æ¥½ã—ã‚‚ã†</p>
                    
                    <div class="game-settings">
                        <div class="setting-item">
                            <label for="difficulty">é›£æ˜“åº¦:</label>
                            <select id="difficulty">
                                <option value="easy">åˆç´š</option>
                                <option value="medium">ä¸­ç´š</option>
                                <option value="hard">ä¸Šç´š</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <label for="radius">æ¤œç´¢ç¯„å›²:</label>
                            <select id="radius">
                                <option value="500">500m</option>
                                <option value="1000" selected>1000m</option>
                                <option value="2000">2000m</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="startNewGame()" class="start-btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                    <button onclick="loadOfflineGame()" class="secondary-btn">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ </button>
                `;
                
                // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                let errorMessage = 'ã‚²ãƒ¼ãƒ é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n';
                if (error.name === 'AbortError') {
                    errorMessage += 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ120ç§’ï¼‰ã€‚ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ãŒé…ã™ãã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage += 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message.includes('HTTP')) {
                    errorMessage += 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                } else {
                    errorMessage += `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`;
                }
                errorMessage += '\n\nã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚’è©¦ã™ã‹ã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                
                alert(errorMessage);
            }
        }
        
        async function waitForGameGeneration(gameId, playerId) {
            const maxAttempts = 30; // æœ€å¤§30å›ï¼ˆ5åˆ†é–“ï¼‰
            let attempts = 0;
            
            // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('start-screen').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚·ãƒŠãƒªã‚ªã‚’ç”Ÿæˆä¸­...</p>
                    <small style="color: #666; margin-top: 10px; display: block;">
                        Game ID: ${gameId.substring(0, 8)}...
                    </small>
                </div>
            `;
            
            while (attempts < maxAttempts) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 10000)); // 10ç§’å¾…æ©Ÿ
                    
                    const statusResponse = await fetchWithTimeout(`${API_BASE_URL}/api/v1/game/${gameId}/status`, {}, 10000);
                    if (!statusResponse.ok) {
                        throw new Error(`Status check failed: ${statusResponse.status}`);
                    }
                    
                    const status = await statusResponse.json();
                    
                    if (status.status === 'ready' || status.scenario) {
                        // ã‚²ãƒ¼ãƒ ç”Ÿæˆå®Œäº†
                        gameData = status;
                        gameData.player_id = playerId;
                        localStorage.setItem('currentGame', JSON.stringify(gameData));
                        showGameScreen();
                        return;
                    } else if (status.status === 'error') {
                        throw new Error(`ã‚²ãƒ¼ãƒ ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${status.message}`);
                    }
                    
                    // ã¾ã ç”Ÿæˆä¸­ã®å ´åˆã€é€²æ—ã‚’æ›´æ–°
                    console.log(`Game generation in progress... (${attempts + 1}/${maxAttempts})`);
                    attempts++;
                    
                } catch (error) {
                    console.error('Status check error:', error);
                    throw error;
                }
            }
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            throw new Error('ã‚²ãƒ¼ãƒ ç”ŸæˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ5åˆ†ï¼‰');
        }
        
        function showGameScreen() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // ã‚·ãƒŠãƒªã‚ªæƒ…å ±è¡¨ç¤ºï¼ˆæ¨ç†è¦ç´ ã‚’å¼·åŒ–ï¼‰
            if (gameData.scenario) {
                const scenario = gameData.scenario;
                document.getElementById('scenario-content').innerHTML = `
                    <h4 style="color: #667eea; margin-bottom: 10px;">${scenario.title || 'äº‹ä»¶ç™ºç”Ÿï¼'}</h4>
                    <p style="margin-bottom: 15px; line-height: 1.6;">${scenario.description || ''}</p>
                    
                    ${scenario.incident_time || scenario.discovery_time ? `
                    <div style="background: #FFEBEE; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>â° æ™‚é–“æƒ…å ±:</strong><br>
                        ${scenario.incident_time ? `<small>äº‹ä»¶ç™ºç”Ÿ: ${scenario.incident_time}</small><br>` : ''}
                        ${scenario.discovery_time ? `<small>ç™ºè¦‹æ™‚åˆ»: ${scenario.discovery_time}</small>` : ''}
                    </div>
                    ` : ''}
                    
                    ${scenario.victim ? `
                    <div style="background: #F5F5F5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>ğŸ’€ è¢«å®³è€…:</strong> ${scenario.victim.name} (${scenario.victim.age}æ­³)<br>
                        <small>${scenario.victim.occupation}</small><br>
                        ${scenario.victim.last_seen ? `<small style="color: #666;">æœ€çµ‚ç›®æ’ƒ: ${scenario.victim.last_seen}</small>` : ''}
                    </div>
                    ` : ''}
                    
                    ${scenario.suspects && scenario.suspects.length > 0 ? `
                    <div style="background: #FFF3E0; padding: 10px; border-radius: 8px;">
                        <strong>ğŸ‘¥ å®¹ç–‘è€…:</strong> ${scenario.suspects.length}å<br>
                        <small style="color: #666;">${scenario.suspects.map(s => s.name).join(', ')}</small>
                    </div>
                    ` : ''}
                    
                    <button class="btn" onclick="toggleScenarioDetails()" style="margin-top: 15px; width: 100%;">
                        å®¹ç–‘è€…ã®è©³ç´°ã‚’è¦‹ã‚‹
                    </button>
                    
                    <div id="scenario-details" style="display: none; margin-top: 15px;">
                        ${scenario.suspects ? scenario.suspects.map(suspect => `
                            <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 3px solid #667eea;">
                                <strong>${suspect.name}</strong> (${suspect.age}æ­³) - ${suspect.occupation}<br>
                                <small>é–¢ä¿‚: ${suspect.relationship}</small><br>
                                ${suspect.alibi ? `<small style="color: #1976D2;">ğŸ“ ã‚¢ãƒªãƒã‚¤: ${suspect.alibi}</small><br>` : ''}
                                ${suspect.motive ? `<small style="color: #D32F2F;">ğŸ’­ å‹•æ©Ÿ: ${suspect.motive}</small><br>` : ''}
                                ${suspect.suspicious_point ? `<small style="color: #F57C00;">âš ï¸ ä¸å¯©ãªç‚¹: ${suspect.suspicious_point}</small>` : ''}
                            </div>
                        `).join('') : ''}
                    </div>
                    
                    ${scenario.timeline && scenario.timeline.length > 0 ? `
                    <button class="btn" onclick="toggleTimeline()" style="margin-top: 10px; width: 100%;">
                        ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¦‹ã‚‹
                    </button>
                    
                    <div id="timeline-details" style="display: none; margin-top: 15px; background: #E3F2FD; padding: 15px; border-radius: 8px;">
                        <strong>ğŸ“… äº‹ä»¶ã®æ™‚ç³»åˆ—:</strong><br>
                        ${scenario.timeline.map(event => `
                            <small style="display: block; margin: 5px 0; padding-left: 20px;">â€¢ ${event}</small>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
            }
            
            // è¨¼æ‹ ãƒªã‚¹ãƒˆè¡¨ç¤º
            const evidenceList = document.getElementById('evidence-list');
            evidenceList.innerHTML = gameData.evidence.map(ev => `
                <li class="evidence-item" id="evidence-${ev.evidence_id}">
                    <div>
                        <strong>${ev.name}</strong><br>
                        <small>ğŸ“ ${ev.poi_name}</small>
                    </div>
                    <span id="distance-${ev.evidence_id}">--m</span>
                </li>
            `).join('');
            
            // ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            initMap();
            
            // GPSæƒ…å ±ãŒã‚ã‚Œã°è·é›¢ã‚’æ›´æ–°
            if (currentPosition) {
                updateDistanceDisplay(currentPosition);
            }
        }
        
        function initMap() {
            if (!currentPosition || !gameData) return;
            
            const centerLat = currentPosition.coords.latitude;
            const centerLng = currentPosition.coords.longitude;
            
            // åœ°å›³ã‚’åˆæœŸåŒ–
            gameMap = L.map('map').setView([centerLat, centerLng], 16);
            
            // OpenStreetMapã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(gameMap);
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            const playerIcon = L.divIcon({
                html: 'ğŸ“',
                iconSize: [30, 30],
                className: 'player-marker'
            });
            
            playerMarker = L.marker([centerLat, centerLng], {icon: playerIcon})
                .addTo(gameMap)
                .bindPopup('ã‚ãªãŸã®ç¾åœ¨ä½ç½®');
            
            // è¨¼æ‹ ã®ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            addEvidenceMarkers();
            
            // æ¨å¥¨ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ
            createRecommendedRoute();
            
            // OSRMãƒ‡ãƒ¢ã‚µãƒ¼ãƒãƒ¼ã®åˆ¶é™ã«ã¤ã„ã¦æ³¨æ„è¡¨ç¤º
            setTimeout(() => {
                showOSRMNotice();
            }, 2000);
            
            // ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            setTimeout(() => {
                gameMap.invalidateSize();
            }, 100);
        }
        
        function addEvidenceMarkers() {
            if (!gameData || !gameData.evidence) return;
            
            // æ—¢å­˜ã®è¨¼æ‹ ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒ«ãƒ¼ãƒˆç·šã‚’ã‚¯ãƒªã‚¢
            evidenceMarkers.forEach(marker => gameMap.removeLayer(marker));
            evidenceMarkers = [];
            clearRouteLines();
            
            gameData.evidence.forEach(evidence => {
                const isDiscovered = document.getElementById(`evidence-${evidence.evidence_id}`)?.classList.contains('discovered') || false;
                
                // è¨¼æ‹ ã®çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
                const evidenceIcon = L.divIcon({
                    html: isDiscovered ? 'âœ…' : 'â“',
                    iconSize: [25, 25],
                    className: isDiscovered ? 'evidence-marker discovered' : 'evidence-marker'
                });
                
                const marker = L.marker([evidence.location.lat, evidence.location.lng], {icon: evidenceIcon})
                    .addTo(gameMap)
                    .bindPopup(`
                        <strong>${evidence.poi_name}</strong><br>
                        ${isDiscovered ? evidence.name : 'æœªç™ºè¦‹ã®è¨¼æ‹ '}<br>
                        <small>è·é›¢: ${calculateDistance(
                            currentPosition.coords.latitude,
                            currentPosition.coords.longitude,
                            evidence.location.lat,
                            evidence.location.lng
                        ).toFixed(0)}m</small>
                    `);
                
                evidenceMarkers.push(marker);
                
                // æœªç™ºè¦‹ã®è¨¼æ‹ ã¸ã®æ–¹å‘ç·šã‚’è¿½åŠ ï¼ˆè¿‘è·é›¢ã®ã¿ã€æ¨å¥¨ãƒ«ãƒ¼ãƒˆã¨åŒºåˆ¥ï¼‰
                if (!isDiscovered) {
                    const distance = calculateDistance(
                        currentPosition.coords.latitude,
                        currentPosition.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    );
                    
                    if (distance <= 75) { // 75mä»¥å†…ãªã‚‰ç›´æ¥æ–¹å‘ç·šã‚’è¡¨ç¤º
                        const routeLine = L.polyline([
                            [currentPosition.coords.latitude, currentPosition.coords.longitude],
                            [evidence.location.lat, evidence.location.lng]
                        ], {
                            color: distance <= 50 ? 'green' : 'orange',
                            weight: 3,
                            opacity: 0.7,
                            dashArray: '5, 5'
                        }).addTo(gameMap);
                        
                        routeLines.push(routeLine);
                    }
                }
            });
        }
        
        function clearRouteLines() {
            routeLines.forEach(line => gameMap.removeLayer(line));
            routeLines = [];
        }
        
        async function createRecommendedRoute() {
            if (!gameData || !gameData.evidence || !currentPosition) return;
            
            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
            if (routingControl) {
                gameMap.removeControl(routingControl);
            }
            if (recommendedRoute) {
                gameMap.removeLayer(recommendedRoute);
            }
            
            // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹
            const startPoint = L.latLng(currentPosition.coords.latitude, currentPosition.coords.longitude);
            
            // è¨¼æ‹ ã®ä½ç½®ã‚’è·é›¢é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæœ€é©ãªãƒ«ãƒ¼ãƒˆé †åºï¼‰
            const evidenceLocations = gameData.evidence
                .map(evidence => ({
                    location: L.latLng(evidence.location.lat, evidence.location.lng),
                    distance: calculateDistance(
                        currentPosition.coords.latitude,
                        currentPosition.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    ),
                    evidence: evidence
                }))
                .sort((a, b) => a.distance - b.distance);
            
            // å¾ªç’°ãƒ«ãƒ¼ãƒˆãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆï¼šã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ â†’ è¨¼æ‹ 1 â†’ è¨¼æ‹ 2 â†’ è¨¼æ‹ 3 â†’ ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹
            const waypoints = [startPoint];
            evidenceLocations.forEach(item => {
                waypoints.push(item.location);
            });
            waypoints.push(startPoint); // æœ€å¾Œã«ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«æˆ»ã‚‹
            
            // å®Ÿéš›ã®é“è·¯ã«æ²¿ã£ãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä½œæˆ
            routingControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function() { return null; }, // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ãƒ«ãƒ¼ãƒˆãƒãƒ¼ã‚«ãƒ¼ã¯éè¡¨ç¤º
                lineOptions: {
                    styles: [{
                        color: '#667eea',
                        weight: 4,
                        opacity: 0.8
                    }]
                },
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'foot' // å¾’æ­©ãƒ«ãƒ¼ãƒˆ
                }),
                // æ—¥æœ¬èªãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚è‹±èªã‚’ä½¿ç”¨
                formatter: new L.Routing.Formatter({
                    language: 'en'
                })
            }).on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // ç·è·é›¢ã¨æ™‚é–“ã‚’è¡¨ç¤º
                const totalDistance = Math.round(summary.totalDistance);
                const totalTime = Math.round(summary.totalTime / 60); // åˆ†ã«å¤‰æ›
                
                console.log(`å¾ªç’°ãƒ«ãƒ¼ãƒˆä½œæˆå®Œäº† - ç·è·é›¢: ${totalDistance}m, äºˆæƒ³æ™‚é–“: ${totalTime}åˆ†`);
                
                // åœ°å›³ä¸Šã«ãƒ«ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
                const routeInfoDiv = document.createElement('div');
                routeInfoDiv.innerHTML = `
                    <div style="position: absolute; top: 10px; right: 10px; background: rgba(102, 126, 234, 0.9); 
                                color: white; padding: 10px; border-radius: 5px; z-index: 1000; font-size: 12px;">
                        ğŸ”„ å¾ªç’°ãƒ«ãƒ¼ãƒˆ<br>
                        ğŸš¶ ç·è·é›¢: ${totalDistance}m<br>
                        â±ï¸ äºˆæƒ³æ™‚é–“: ${totalTime}åˆ†<br>
                        ğŸ“Š è¨¼æ‹ : ${evidenceLocations.length}ç®‡æ‰€<br>
                        <small>å®Ÿéš›ã®æ­©è¡Œè·¯ä½¿ç”¨</small>
                    </div>
                `;
                
                // æ—¢å­˜ã®æƒ…å ±ãƒ‘ãƒãƒ«ã‚’å‰Šé™¤
                const existingPanel = document.querySelector('.route-info-panel');
                if (existingPanel) existingPanel.remove();
                
                routeInfoDiv.className = 'route-info-panel';
                document.getElementById('map').appendChild(routeInfoDiv);
                
            }).on('routingerror', function(e) {
                console.warn('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', e.error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç›´ç·šãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º
                createSimpleFallbackRoute(waypoints);
            }).addTo(gameMap);
            
            // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                const routingContainer = document.querySelector('.leaflet-routing-container');
                if (routingContainer) {
                    routingContainer.style.display = 'none';
                }
            }, 100);
        }
        
        function createSimpleFallbackRoute(waypoints) {
            console.log('OSRMã‚µãƒ¼ãƒãƒ¼ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç°¡æ˜“ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
            
            // ç›´ç·šãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ
            const routeCoordinates = waypoints.map(wp => [wp.lat, wp.lng]);
            
            recommendedRoute = L.polyline(routeCoordinates, {
                color: '#FF6B6B',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 5'
            }).addTo(gameMap);
            
            // ç°¡æ˜“è·é›¢è¨ˆç®—
            let totalDistance = 0;
            for (let i = 0; i < routeCoordinates.length - 1; i++) {
                const [lat1, lng1] = routeCoordinates[i];
                const [lat2, lng2] = routeCoordinates[i + 1];
                totalDistance += calculateDistance(lat1, lng1, lat2, lng2);
            }
            
            // ç°¡æ˜“æƒ…å ±ãƒ‘ãƒãƒ«è¡¨ç¤º
            const routeInfoDiv = document.createElement('div');
            routeInfoDiv.innerHTML = `
                <div style="position: absolute; top: 10px; right: 10px; background: rgba(255, 107, 107, 0.9); 
                            color: white; padding: 10px; border-radius: 5px; z-index: 1000; font-size: 12px;">
                    âš ï¸ ç°¡æ˜“ãƒ«ãƒ¼ãƒˆ<br>
                    ğŸš¶ æ¦‚ç®—è·é›¢: ${Math.round(totalDistance)}m<br>
                    ğŸ“Š è¨¼æ‹ : ${waypoints.length - 1}ç®‡æ‰€<br>
                    <small>ç›´ç·šè·é›¢ï¼ˆå‚è€ƒï¼‰</small>
                </div>
            `;
            
            const existingPanel = document.querySelector('.route-info-panel');
            if (existingPanel) existingPanel.remove();
            
            routeInfoDiv.className = 'route-info-panel';
            document.getElementById('map').appendChild(routeInfoDiv);
        }
        
        function showOSRMNotice() {
            // ä¸€åº¦ã ã‘è¡¨ç¤º
            if (localStorage.getItem('osrm-notice-shown')) return;
            
            const notice = `
ğŸ—ºï¸ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã«ã¤ã„ã¦

ç¾åœ¨ã€ãƒ‡ãƒ¢ç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ç‚¹ã«ã”æ³¨æ„ãã ã•ã„ï¼š

â€¢ æ™‚ã€…åˆ©ç”¨ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™
â€¢ ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€Ÿåº¦ãŒåˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
â€¢ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ä½¿ç”¨ã«ã¯é©ã—ã¦ã„ã¾ã›ã‚“

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«å¤±æ•—ã—ãŸå ´åˆã¯ã€
ç°¡æ˜“çš„ãªç›´ç·šãƒ«ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»Šå›ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            `;
            
            if (confirm(notice + '\n\näº†è§£ã—ã¾ã—ãŸã‹ï¼Ÿ')) {
                localStorage.setItem('osrm-notice-shown', 'true');
            }
        }
        
        let routeVisible = true;
        
        function toggleRecommendedRoute() {
            if (!gameMap) return;
            
            if (routeVisible) {
                // ãƒ«ãƒ¼ãƒˆã‚’éè¡¨ç¤º
                if (routingControl) {
                    gameMap.removeControl(routingControl);
                }
                if (recommendedRoute) {
                    gameMap.removeLayer(recommendedRoute);
                }
                document.querySelector('.route-info-panel')?.remove();
                
                routeVisible = false;
            } else {
                // ãƒ«ãƒ¼ãƒˆã‚’å†è¡¨ç¤º
                createRecommendedRoute();
                routeVisible = true;
            }
        }
        
        function toggleWalkingDirections() {
            const routingContainer = document.querySelector('.leaflet-routing-container');
            if (routingContainer) {
                if (routingContainer.style.display === 'none') {
                    routingContainer.style.display = 'block';
                } else {
                    routingContainer.style.display = 'none';
                }
            }
        }
        
        async function checkNearbyEvidence() {
            if (!currentPosition || !gameData) {
                alert('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯GPSæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // å„è¨¼æ‹ ã¨ã®è·é›¢ã‚’è¨ˆç®—
            for (const evidence of gameData.evidence) {
                const distance = calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    evidence.location.lat,
                    evidence.location.lng
                );
                
                document.getElementById(`distance-${evidence.evidence_id}`).textContent = `${Math.round(distance)}m`;
                
                // 50mä»¥å†…ãªã‚‰ç™ºè¦‹å¯èƒ½
                if (distance <= 50) {
                    discoverEvidence(evidence);
                }
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        async function discoverEvidence(evidence) {
            const evidenceItem = document.getElementById(`evidence-${evidence.evidence_id}`);
            if (evidenceItem.classList.contains('discovered')) {
                return; // æ—¢ã«ç™ºè¦‹æ¸ˆã¿
            }
            
            // ç™ºè¦‹é€šçŸ¥
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // è©³ç´°ãªè¨¼æ‹ æƒ…å ±ã‚’è¡¨ç¤º
            const evidenceDetails = `
ğŸ‰ è¨¼æ‹ ã‚’ç™ºè¦‹ï¼

ğŸ“ å ´æ‰€: ${evidence.poi_name}
ğŸ” è¨¼æ‹ : ${evidence.name}

ğŸ“ è©³ç´°:
${evidence.description || 'è©³ç´°ãªåˆ†æãŒå¿…è¦ã§ã™ã€‚'}

ğŸ’¡ ãƒ’ãƒ³ãƒˆ:
${evidence.hint || 'ã“ã®è¨¼æ‹ ã®æ„å‘³ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚'}

é‡è¦åº¦: ${evidence.importance === 'critical' ? 'â­â­â­ é‡è¦' : 'â­â­ æ™®é€š'}
            `;
            
            alert(evidenceDetails);
            evidenceItem.classList.add('discovered');
            
            // åœ°å›³ä¸Šã®è¨¼æ‹ ãƒãƒ¼ã‚«ãƒ¼ã‚‚æ›´æ–°
            if (gameMap) {
                addEvidenceMarkers();
            }
            
            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒãƒƒãƒ—ã®è¨¼æ‹ ãƒãƒ¼ã‚«ãƒ¼ã‚‚æ›´æ–°
            if (fullscreenMap) {
                addFullscreenEvidenceMarkers();
                updateMapGameStatus();
            }
            
            // ã‚µãƒ¼ãƒãƒ¼ã«ç™ºè¦‹ã‚’å ±å‘Š
            try {
                await fetchWithTimeout(`${API_BASE_URL}/api/v1/evidence/discover`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        game_id: gameData.game_id,
                        player_id: gameData.player_id || 'mobile-player',
                        current_location: {
                            lat: currentPosition.coords.latitude,
                            lng: currentPosition.coords.longitude
                        },
                        evidence_id: evidence.evidence_id
                    })
                }, 15000);
            } catch (error) {
                console.error('Evidence discovery error:', error);
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ç™ºè¦‹ã‚’è¨˜éŒ²
                saveOfflineDiscovery(evidence.evidence_id);
            }
            
            // ã™ã¹ã¦ã®è¨¼æ‹ ã‚’ç™ºè¦‹ã—ãŸã‹ç¢ºèª
            checkAllEvidenceFound();
        }
        
        function checkAllEvidenceFound() {
            const allEvidence = document.querySelectorAll('.evidence-item');
            const discoveredEvidence = document.querySelectorAll('.evidence-item.discovered');
            
            if (allEvidence.length === discoveredEvidence.length) {
                alert('ğŸ‰ ã™ã¹ã¦ã®è¨¼æ‹ ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼\næ¨ç†ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã¿ã¾ã™ã€‚');
                showDeductionPhase();
            }
        }
        
        async function showDeductionPhase() {
            // æ¨ç†ãƒ•ã‚§ãƒ¼ã‚ºã®UIã‚’è¡¨ç¤º
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('deduction-screen').style.display = 'block';
            
            // å®¹ç–‘è€…æƒ…å ±ã‚’å–å¾—
            const suspects = gameData.scenario.suspects || [];
            let questionsRemaining = 10;
            
            document.getElementById('deduction-screen').innerHTML = `
                <div class="card">
                    <h2>ğŸ•µï¸ æ¨ç†ãƒ•ã‚§ãƒ¼ã‚º</h2>
                    <p>è¨¼æ‹ ã‚’é›†ã‚çµ‚ã‚ã‚Šã¾ã—ãŸï¼å®¹ç–‘è€…ã«è³ªå•ã—ã¦çœŸçŠ¯äººã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã—ã‚‡ã†ã€‚</p>
                    <p style="color: #666; font-size: 0.9em;">æ®‹ã‚Šè³ªå•å›æ•°: <span id="questions-remaining">${questionsRemaining}</span>å›</p>
                </div>
                
                <div class="card">
                    <h3>ğŸ‘¥ å®¹ç–‘è€…ãƒªã‚¹ãƒˆ</h3>
                    <div id="suspects-list">
                        ${suspects.map(suspect => `
                            <div class="suspect-card" onclick="selectSuspect('${suspect.name}')">
                                <h4>${suspect.name} (${suspect.age}æ­³)</h4>
                                <p><strong>è·æ¥­:</strong> ${suspect.occupation}</p>
                                <p><strong>é–¢ä¿‚:</strong> ${suspect.relationship}</p>
                                <p><strong>ã‚¢ãƒªãƒã‚¤:</strong> ${suspect.alibi}</p>
                                <p><strong>å‹•æ©Ÿ:</strong> ${suspect.motive}</p>
                                ${suspect.suspicious_point ? `<p style="color: #F57C00;"><strong>ç–‘å•ç‚¹:</strong> ${suspect.suspicious_point}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="card" id="question-section" style="display: none;">
                    <h3>ğŸ” å®¹ç–‘è€…ã¸ã®è³ªå•</h3>
                    <p><strong>é¸æŠä¸­:</strong> <span id="selected-suspect"></span></p>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">è³ªå•ã‚¿ã‚¤ãƒ—:</label>
                        <select id="question-type" style="width: 100%; padding: 10px; margin-top: 5px;">
                            <option value="alibi">ã‚¢ãƒªãƒã‚¤ã«ã¤ã„ã¦è©³ã—ã</option>
                            <option value="motive">å‹•æ©Ÿã«ã¤ã„ã¦</option>
                            <option value="relationship">è¢«å®³è€…ã¨ã®é–¢ä¿‚</option>
                            <option value="witness">ä»–ã®äººã«ã¤ã„ã¦</option>
                            <option value="behavior">äº‹ä»¶å½“æ—¥ã®è¡Œå‹•</option>
                            <option value="evidence">è¨¼æ‹ ã«ã¤ã„ã¦</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="askSuspectQuestion()" style="width: 100%;">
                        è³ªå•ã™ã‚‹
                    </button>
                </div>
                
                <div class="card">
                    <h3>ğŸ’¬ è³ªå•å±¥æ­´</h3>
                    <div id="conversation-log" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #666; font-style: italic;">ã¾ã è³ªå•ã—ã¦ã„ã¾ã›ã‚“</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ¯ çŠ¯äººã‚’ç‰¹å®š</h3>
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">çœŸçŠ¯äººã¯èª°ã§ã™ã‹ï¼Ÿ</label>
                        <select id="culprit-guess" style="width: 100%; padding: 10px; margin-top: 5px;">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
                            ${suspects.map(suspect => `
                                <option value="${suspect.name}">${suspect.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">æ¨ç†ã®æ ¹æ‹ ã‚’èª¬æ˜ã—ã¦ãã ã•ã„:</label>
                        <textarea id="deduction-reasoning" style="width: 100%; height: 100px; padding: 10px; margin-top: 5px;" 
                            placeholder="è¨¼æ‹ ã¨è³ªå•ã‹ã‚‰å¾—ãŸæƒ…å ±ã‚’åŸºã«ã€ãªãœã“ã®äººãŒçŠ¯äººã ã¨æ€ã†ã‹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    
                    <button class="btn success" onclick="submitFinalDeduction()" style="width: 100%;">
                        æ¨ç†ã‚’æå‡ºã™ã‚‹
                    </button>
                </div>
                
                <div id="deduction-result" style="display: none;">
                    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                </div>
            `;
        }
        
        function showScreen(screen) {
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // å…¨ã¦ã®ç”»é¢ã‚’éè¡¨ç¤º
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('deduction-screen').style.display = 'none';
            document.getElementById('map-screen').style.display = 'none';
            document.getElementById('deduction-tab-screen').style.display = 'none';
            document.getElementById('profile-screen').style.display = 'none';
            
            // æŒ‡å®šã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤º
            switch (screen) {
                case 'game':
                    if (gameData) {
                        document.getElementById('game-screen').style.display = 'block';
                    } else {
                        document.getElementById('start-screen').style.display = 'block';
                    }
                    break;
                case 'map':
                    document.getElementById('map-screen').style.display = 'block';
                    initFullscreenMap();
                    break;
                case 'deduction':
                    document.getElementById('deduction-tab-screen').style.display = 'block';
                    loadDeductionNotes();
                    updateGameInfoDisplay();
                    break;
                case 'profile':
                    document.getElementById('profile-screen').style.display = 'block';
                    break;
            }
        }
        
        function loadOfflineGame() {
            const savedGame = localStorage.getItem('currentGame');
            if (savedGame) {
                gameData = JSON.parse(savedGame);
                showGameScreen();
            }
        }
        
        function saveOfflineDiscovery(evidenceId) {
            const discoveries = JSON.parse(localStorage.getItem('discoveries') || '[]');
            discoveries.push({
                evidence_id: evidenceId,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('discoveries', JSON.stringify(discoveries));
        }
        
        function updatePlayerLocationOnMap(position) {
            if (gameMap && playerMarker) {
                const newLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
                playerMarker.setLatLng(newLatLng);
                
                // è¨¼æ‹ ãƒãƒ¼ã‚«ãƒ¼ã®è·é›¢æƒ…å ±ã‚‚æ›´æ–°
                addEvidenceMarkers();
            }
            
            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒãƒƒãƒ—ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‚‚æ›´æ–°
            if (fullscreenMap && fullscreenPlayerMarker) {
                const newLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
                fullscreenPlayerMarker.setLatLng(newLatLng);
                
                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒãƒƒãƒ—ã®è¨¼æ‹ ãƒãƒ¼ã‚«ãƒ¼ã‚‚æ›´æ–°
                if (gameData) {
                    addFullscreenEvidenceMarkers();
                    updateMapGameStatus();
                }
            }
        }
        
        function checkEvidenceProximity(position) {
            // è‡ªå‹•çš„ã«è¿‘ãã®è¨¼æ‹ ã‚’ãƒã‚§ãƒƒã‚¯
            if (gameData && gameData.evidence) {
                for (const evidence of gameData.evidence) {
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    );
                    
                    if (distance <= 30) {
                        // 30mä»¥å†…ã«ãªã£ãŸã‚‰é€šçŸ¥
                        showProximityNotification(evidence, distance);
                    }
                }
            }
        }
        
        function updateDistanceDisplay(position) {
            // å„è¨¼æ‹ ã¨ã®è·é›¢ã‚’è¡¨ç¤ºæ›´æ–°
            if (gameData && gameData.evidence) {
                for (const evidence of gameData.evidence) {
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    );
                    
                    const distanceElement = document.getElementById(`distance-${evidence.evidence_id}`);
                    if (distanceElement) {
                        distanceElement.textContent = `${Math.round(distance)}m`;
                    }
                }
            }
        }
        
        function showProximityNotification(evidence, distance) {
            if (Notification.permission === 'granted') {
                new Notification('è¨¼æ‹ ãŒè¿‘ãã«ã‚ã‚Šã¾ã™ï¼', {
                    body: `${evidence.name}ã¾ã§ç´„${Math.round(distance)}m`,
                    icon: '/static/icons/icon-192x192.png',
                    vibrate: [200, 100, 200]
                });
            }
        }
        
        function toggleScenarioDetails() {
            const details = document.getElementById('scenario-details');
            const button = event.target;
            if (details.style.display === 'none') {
                details.style.display = 'block';
                button.textContent = 'å®¹ç–‘è€…ã®è©³ç´°ã‚’éš ã™';
            } else {
                details.style.display = 'none';
                button.textContent = 'å®¹ç–‘è€…ã®è©³ç´°ã‚’è¦‹ã‚‹';
            }
        }
        
        function toggleTimeline() {
            const timeline = document.getElementById('timeline-details');
            const button = event.target;
            if (timeline.style.display === 'none') {
                timeline.style.display = 'block';
                button.textContent = 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éš ã™';
            } else {
                timeline.style.display = 'none';
                button.textContent = 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¦‹ã‚‹';
            }
        }
        
        // æ¨ç†ãƒ•ã‚§ãƒ¼ã‚ºã®æ©Ÿèƒ½
        let selectedSuspectName = null;
        let questionsAsked = 0;
        const maxQuestions = 10;
        
        function selectSuspect(suspectName) {
            selectedSuspectName = suspectName;
            document.getElementById('selected-suspect').textContent = suspectName;
            document.getElementById('question-section').style.display = 'block';
            
            // é¸æŠã•ã‚ŒãŸå®¹ç–‘è€…ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.suspect-card').forEach(card => {
                card.style.border = '2px solid #E0E0E0';
            });
            event.target.style.border = '2px solid #667eea';
        }
        
        async function askSuspectQuestion() {
            if (!selectedSuspectName) {
                alert('å®¹ç–‘è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (questionsAsked >= maxQuestions) {
                alert('è³ªå•å›æ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ');
                return;
            }
            
            const questionType = document.getElementById('question-type').value;
            
            try {
                const response = await fetchWithTimeout(`${API_BASE_URL}/api/v1/deduction/question`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        game_id: gameData.game_id,
                        suspect_name: selectedSuspectName,
                        question_type: questionType
                    })
                }, 15000);
                
                if (response.ok) {
                    const result = await response.json();
                    displayQuestionResult(result);
                    questionsAsked++;
                    document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
                } else {
                    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒãªã„å ´åˆã®ç°¡æ˜“å›ç­”ç”Ÿæˆ
                    const mockAnswer = generateMockAnswer(selectedSuspectName, questionType);
                    displayQuestionResult(mockAnswer);
                    questionsAsked++;
                    document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
                }
            } catch (error) {
                console.error('Question error:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç°¡æ˜“å›ç­”ã‚’ç”Ÿæˆ
                const mockAnswer = generateMockAnswer(selectedSuspectName, questionType);
                displayQuestionResult(mockAnswer);
                questionsAsked++;
                document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
            }
        }
        
        function generateMockAnswer(suspectName, questionType) {
            const suspect = gameData.scenario.suspects.find(s => s.name === suspectName);
            const isCulprit = suspect.name === gameData.scenario.culprit;
            
            let answer = '';
            let reaction = '';
            
            switch (questionType) {
                case 'alibi':
                    answer = suspect.alibi || 'ç‰¹ã«ã‚¢ãƒªãƒã‚¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                    reaction = isCulprit ? 'å°‘ã—ç·Šå¼µã—ãŸæ§˜å­ã§ç­”ãˆã‚‹ã€‚' : 'è½ã¡ç€ã„ã¦ç­”ãˆã‚‹ã€‚';
                    break;
                case 'motive':
                    answer = suspect.motive ? `${suspect.motive}ã§ã™ãŒã€æ®ºå®³ã™ã‚‹ã»ã©ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚` : 'ç‰¹ã«å‹•æ©Ÿã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                    reaction = isCulprit ? 'è¡¨æƒ…ãŒå¼·å¼µã‚‹ã€‚' : 'ç‡ç›´ã«ç­”ãˆã‚‹ã€‚';
                    break;
                case 'relationship':
                    answer = `è¢«å®³è€…ã¨ã¯${suspect.relationship}ã®é–¢ä¿‚ã§ã—ãŸã€‚`;
                    reaction = isCulprit ? 'ç›®ã‚’é€¸ã‚‰ã—ãŒã¡ã«ãªã‚‹ã€‚' : 'æ™®é€šã«ç­”ãˆã‚‹ã€‚';
                    break;
                case 'behavior':
                    answer = isCulprit && suspect.contradiction ? 
                        suspect.contradiction : 
                        'ã„ã¤ã‚‚é€šã‚Šã®æ—¥å¸¸ã‚’éã”ã—ã¦ã„ã¾ã—ãŸã€‚';
                    reaction = isCulprit ? 'è©³ç´°ã‚’é¿ã‘ãŸãŒã‚‹ã€‚' : 'ã¯ã£ãã‚Šã¨ç­”ãˆã‚‹ã€‚';
                    break;
                default:
                    answer = 'ç‰¹ã«ãŠç­”ãˆã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                    reaction = 'å›°ã£ãŸè¡¨æƒ…ã‚’è¦‹ã›ã‚‹ã€‚';
            }
            
            return {
                question: `${questionType}ã«ã¤ã„ã¦è³ªå•ã—ã¾ã—ãŸ`,
                answer: answer,
                reaction: reaction,
                suspect_name: suspectName,
                hint_revealed: isCulprit && Math.random() > 0.7 ? suspect.contradiction || 'ä½•ã‹ã‚’éš ã—ã¦ã„ã‚‹æ§˜å­' : null
            };
        }
        
        function displayQuestionResult(result) {
            const logDiv = document.getElementById('conversation-log');
            if (logDiv.innerHTML.includes('ã¾ã è³ªå•ã—ã¦ã„ã¾ã›ã‚“')) {
                logDiv.innerHTML = '';
            }
            
            const conversationHTML = `
                <div style="background: #E8F5E9; padding: 10px; margin: 10px 0; border-radius: 8px;">
                    <p><strong>ğŸ” è³ªå•:</strong> ${result.suspect_name}ã«${result.question}</p>
                </div>
                <div style="background: #FFF3E0; padding: 10px; margin: 10px 0; border-radius: 8px;">
                    <p><strong>ğŸ‘¤ ${result.suspect_name}:</strong></p>
                    <p>${result.answer}</p>
                    <p style="font-style: italic; color: #666; margin-top: 8px;">${result.reaction}</p>
                    ${result.hint_revealed ? `<p style="color: #2E7D32; margin-top: 8px;">ğŸ’¡ æ°—ã¥ã„ãŸç‚¹: ${result.hint_revealed}</p>` : ''}
                </div>
            `;
            logDiv.innerHTML = conversationHTML + logDiv.innerHTML;
        }
        
        async function submitFinalDeduction() {
            const culpritGuess = document.getElementById('culprit-guess').value;
            const reasoning = document.getElementById('deduction-reasoning').value;
            
            if (!culpritGuess || !reasoning) {
                alert('çŠ¯äººã®é¸æŠã¨æ¨ç†ã®æ ¹æ‹ ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ­£è§£åˆ¤å®š
            const isCorrect = culpritGuess === gameData.scenario.culprit;
            const trueCulprit = gameData.scenario.culprit;
            const trueMotive = gameData.scenario.true_motive;
            
            // çµæœè¡¨ç¤º
            document.getElementById('deduction-result').style.display = 'block';
            document.getElementById('deduction-result').innerHTML = `
                <div class="card" style="background: ${isCorrect ? '#E8F5E9' : '#FFEBEE'};">
                    <h3 style="color: ${isCorrect ? '#2E7D32' : '#C62828'};">
                        ${isCorrect ? 'ğŸ‰ æ­£è§£ï¼' : 'ğŸ˜” ä¸æ­£è§£...'}
                    </h3>
                    
                    <div style="margin: 20px 0;">
                        <p><strong>ã‚ãªãŸã®æ¨ç†:</strong> ${culpritGuess}</p>
                        <p><strong>æ­£è§£:</strong> ${trueCulprit}</p>
                        <p style="margin-top: 10px;"><strong>ã‚ãªãŸã®æ¨ç†æ ¹æ‹ :</strong></p>
                        <p style="background: #F5F5F5; padding: 10px; border-radius: 5px;">${reasoning}</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4>ğŸ“– äº‹ä»¶ã®çœŸç›¸</h4>
                        <p><strong>çœŸçŠ¯äºº:</strong> ${trueCulprit}</p>
                        <p><strong>çœŸã®å‹•æ©Ÿ:</strong> ${trueMotive}</p>
                        <p><strong>çŠ¯è¡Œæ–¹æ³•:</strong> ${gameData.scenario.method}</p>
                        ${gameData.scenario.trick ? `<p><strong>ãƒˆãƒªãƒƒã‚¯:</strong> ${gameData.scenario.trick}</p>` : ''}
                    </div>
                    
                    <div style="background: #E3F2FD; padding: 15px; border-radius: 8px;">
                        <h4>ğŸ† çµæœ</h4>
                        <p>è³ªå•å›æ•°: ${questionsAsked}/${maxQuestions}å›ä½¿ç”¨</p>
                        <p>è¨¼æ‹ ç™ºè¦‹: ${document.querySelectorAll('.evidence-item.discovered').length}/${document.querySelectorAll('.evidence-item').length}å€‹</p>
                        ${isCorrect ? 
                            `<p style="color: #2E7D32; font-weight: bold;">ğŸŠ äº‹ä»¶è§£æ±ºï¼ç´ æ™´ã‚‰ã—ã„æ¨ç†ã§ã—ãŸï¼</p>` : 
                            `<p style="color: #D32F2F;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚è¨¼æ‹ ã¨è¨¼è¨€ã‚’ã‚ˆãæ¤œè¨¼ã—ã¦ãã ã•ã„ã€‚</p>`
                        }
                    </div>
                    
                    <button class="btn" onclick="location.reload()" style="margin-top: 20px; width: 100%;">
                        æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
                    </button>
                </div>
            `;
            
            // çµæœã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('deduction-result').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒãƒƒãƒ—é–¢é€£æ©Ÿèƒ½
        function initFullscreenMap() {
            if (!currentPosition) {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬é§…ï¼‰ã‚’ä½¿ç”¨
                currentPosition = {
                    coords: {
                        latitude: 35.6812,
                        longitude: 139.7671,
                        accuracy: 100
                    }
                };
            }
            
            const centerLat = currentPosition.coords.latitude;
            const centerLng = currentPosition.coords.longitude;
            
            // æ—¢å­˜ã®ãƒãƒƒãƒ—ãŒã‚ã‚Œã°ç ´æ£„
            if (fullscreenMap) {
                fullscreenMap.remove();
            }
            
            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
            fullscreenMap = L.map('fullscreen-map').setView([centerLat, centerLng], 16);
            
            // OpenStreetMapã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(fullscreenMap);
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            const playerIcon = L.divIcon({
                html: 'ğŸ“',
                iconSize: [30, 30],
                className: 'player-marker'
            });
            
            fullscreenPlayerMarker = L.marker([centerLat, centerLng], {icon: playerIcon})
                .addTo(fullscreenMap)
                .bindPopup('ã‚ãªãŸã®ç¾åœ¨ä½ç½®');
            
            // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¨¼æ‹ ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            if (gameData) {
                addFullscreenEvidenceMarkers();
                updateMapGameStatus();
            } else {
                updateMapGameStatus();
            }
            
            // ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            setTimeout(() => {
                fullscreenMap.invalidateSize();
            }, 200);
        }
        
        function addFullscreenEvidenceMarkers() {
            if (!gameData || !gameData.evidence || !fullscreenMap) return;
            
            // æ—¢å­˜ã®è¨¼æ‹ ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            fullscreenEvidenceMarkers.forEach(marker => fullscreenMap.removeLayer(marker));
            fullscreenEvidenceMarkers = [];
            
            gameData.evidence.forEach(evidence => {
                const isDiscovered = document.getElementById(`evidence-${evidence.evidence_id}`)?.classList.contains('discovered') || false;
                
                const evidenceIcon = L.divIcon({
                    html: isDiscovered ? 'âœ…' : 'â“',
                    iconSize: [25, 25],
                    className: isDiscovered ? 'evidence-marker discovered' : 'evidence-marker'
                });
                
                const distance = calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    evidence.location.lat,
                    evidence.location.lng
                );
                
                const marker = L.marker([evidence.location.lat, evidence.location.lng], {icon: evidenceIcon})
                    .addTo(fullscreenMap)
                    .bindPopup(`
                        <strong>${evidence.poi_name}</strong><br>
                        ${isDiscovered ? evidence.name : 'æœªç™ºè¦‹ã®è¨¼æ‹ '}<br>
                        <small>è·é›¢: ${distance.toFixed(0)}m</small>
                    `);
                
                fullscreenEvidenceMarkers.push(marker);
            });
        }
        
        function updateMapGameStatus() {
            const statusDiv = document.getElementById('map-game-status');
            const evidenceListDiv = document.getElementById('map-evidence-list');
            const evidenceContentDiv = document.getElementById('map-evidence-content');
            
            if (!gameData) {
                statusDiv.innerHTML = '<p>ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                evidenceListDiv.style.display = 'none';
                return;
            }
            
            const discoveredCount = document.querySelectorAll('.evidence-item.discovered').length;
            const totalCount = gameData.evidence.length;
            
            statusDiv.innerHTML = `
                <p><strong>ğŸ® ã‚²ãƒ¼ãƒ é€²è¡Œä¸­</strong></p>
                <p>ğŸ“ ç¾åœ¨åœ°: ${gameData.scenario?.title || 'ãƒŸã‚¹ãƒ†ãƒªãƒ¼èª¿æŸ»ä¸­'}</p>
                <p>ğŸ” è¨¼æ‹ ç™ºè¦‹: ${discoveredCount}/${totalCount}å€‹</p>
                <p>ğŸ“Š é€²æ—: ${Math.round((discoveredCount/totalCount)*100)}%</p>
            `;
            
            evidenceListDiv.style.display = 'block';
            evidenceContentDiv.innerHTML = gameData.evidence.map(ev => {
                const isDiscovered = document.getElementById(`evidence-${ev.evidence_id}`)?.classList.contains('discovered') || false;
                const distance = calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    ev.location.lat,
                    ev.location.lng
                );
                
                return `
                    <div style="background: ${isDiscovered ? '#E8F5E9' : '#F5F5F5'}; padding: 10px; margin: 5px 0; border-radius: 8px; ${isDiscovered ? 'border: 2px solid #4CAF50;' : ''}">
                        <strong>${isDiscovered ? 'âœ…' : 'â“'} ${isDiscovered ? ev.name : 'æœªç™ºè¦‹ã®è¨¼æ‹ '}</strong><br>
                        <small>ğŸ“ ${ev.poi_name} (${Math.round(distance)}m)</small>
                    </div>
                `;
            }).join('');
        }
        
        function loadDeductionNotes() {
            const gameId = gameData?.game_id || 'default';
            const notes = localStorage.getItem(`deduction-notes-${gameId}`) || '';
            document.getElementById('deduction-notes').value = notes;
            
            // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
            document.getElementById('deduction-notes').addEventListener('input', function() {
                localStorage.setItem(`deduction-notes-${gameId}`, this.value);
            });
        }
        
        function updateGameInfoDisplay() {
            const gameInfoDiv = document.getElementById('current-game-info');
            const gameInfoContentDiv = document.getElementById('game-info-content');
            
            if (!gameData) {
                gameInfoDiv.style.display = 'none';
                return;
            }
            
            gameInfoDiv.style.display = 'block';
            const scenario = gameData.scenario;
            
            gameInfoContentDiv.innerHTML = `
                <div style="background: #F5F5F5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <strong>ğŸ“– ${scenario?.title || 'äº‹ä»¶èª¿æŸ»ä¸­'}</strong><br>
                    <small>${scenario?.description || ''}</small>
                </div>
                
                ${scenario?.suspects ? `
                <div style="background: #FFF3E0; padding: 10px; border-radius: 8px;">
                    <strong>ğŸ‘¥ å®¹ç–‘è€… (${scenario.suspects.length}å):</strong><br>
                    ${scenario.suspects.map(suspect => `
                        <small>â€¢ ${suspect.name} (${suspect.age}æ­³) - ${suspect.occupation}</small>
                    `).join('<br>')}
                </div>
                ` : ''}
            `;
        }
        
        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            startGPSTracking();
            
            // é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ä¿å­˜æ¸ˆã¿ã‚²ãƒ¼ãƒ ãŒã‚ã‚‹ã‹ç¢ºèª
            const savedGame = localStorage.getItem('currentGame');
            if (savedGame) {
                if (confirm('å‰å›ã®ã‚²ãƒ¼ãƒ ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ')) {
                    loadOfflineGame();
                }
            }
        });
    </script>
</body>
</html>