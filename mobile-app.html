<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    
    <title>AIミステリー散歩</title>
    
    <!-- PWA マニフェスト -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS用アイコン -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
        }
        
        /* ヘッダー */
        .app-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: env(safe-area-inset-top) 20px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        /* メインコンテンツ */
        .main-content {
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* カードスタイル */
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* ボタンスタイル */
        .btn {
            background: linear-gradient(45deg, #3498DB, #2980B9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #27AE60, #229954);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #E74C3C, #C0392B);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* GPS状態表示 */
        .gps-status {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .gps-status.error {
            background: #FFEBEE;
            color: #C62828;
        }
        
        /* マップコンテナ */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        /* 証拠リスト */
        .evidence-list {
            list-style: none;
        }
        
        .evidence-item {
            background: #F5F5F5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .evidence-item.discovered {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
        }
        
        /* 推理フェーズ */
        .deduction-container {
            display: none;
        }
        
        .suspect-card {
            background: white;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .suspect-card.selected {
            border-color: #3498DB;
            background: #E3F2FD;
        }
        
        /* ローディング */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498DB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ボトムナビゲーション */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #999;
            transition: color 0.3s;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        /* オフライン表示 */
        .offline-banner {
            background: #FFF3E0;
            color: #F57F17;
            padding: 10px;
            text-align: center;
            display: none;
        }
        
        body.offline .offline-banner {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- オフラインバナー -->
        <div class="offline-banner">
            📡 オフラインモード - 一部機能が制限されています
        </div>
        
        <!-- ヘッダー -->
        <header class="app-header">
            <h1>🕵️ AIミステリー散歩</h1>
            <p style="font-size: 0.9em; opacity: 0.9;">リアルワールド推理ゲーム</p>
        </header>
        
        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- GPS状態 -->
            <div id="gps-status" class="gps-status">
                📍 GPS情報を取得中...
            </div>
            
            <!-- ゲーム開始画面 -->
            <div id="start-screen" class="card">
                <h2 style="margin-bottom: 20px;">🎮 新しいゲームを開始</h2>
                <p style="margin-bottom: 20px;">現在地周辺のミステリーを生成します</p>
                
                <div style="margin-bottom: 15px;">
                    <label>難易度:</label>
                    <select id="difficulty" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px;">
                        <option value="easy">簡単（3名の容疑者）</option>
                        <option value="normal" selected>普通（4-5名の容疑者）</option>
                        <option value="hard">難しい（6名以上の容疑者）</option>
                    </select>
                </div>
                
                <button class="btn success" onclick="startNewGame()">
                    ゲームを開始する
                </button>
            </div>
            
            <!-- ゲームプレイ画面 -->
            <div id="game-screen" style="display: none;">
                <!-- シナリオ情報 -->
                <div class="card" id="scenario-info">
                    <h3>📖 事件概要</h3>
                    <div id="scenario-content">
                        <!-- 動的に生成 -->
                    </div>
                </div>
                
                <!-- マップ -->
                <div id="map"></div>
                
                <!-- 証拠リスト -->
                <div class="card">
                    <h3>🔍 証拠リスト</h3>
                    <ul id="evidence-list" class="evidence-list">
                        <!-- 動的に生成 -->
                    </ul>
                </div>
                
                <!-- アクションボタン -->
                <div class="card">
                    <button class="btn" onclick="checkNearbyEvidence()">
                        📍 近くの証拠をチェック
                    </button>
                </div>
            </div>
            
            <!-- 推理フェーズ -->
            <div id="deduction-screen" class="deduction-container">
                <!-- 動的に生成 -->
            </div>
        </main>
        
        <!-- ボトムナビゲーション -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('game')">
                🎮 ゲーム
            </div>
            <div class="nav-item" onclick="showScreen('map')">
                🗺️ マップ
            </div>
            <div class="nav-item" onclick="showScreen('deduction')">
                🕵️ 推理
            </div>
            <div class="nav-item" onclick="showScreen('profile')">
                👤 プロフィール
            </div>
        </nav>
    </div>
    
    <script>
        // Service Worker登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }
        
        // PWAインストールプロンプト
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.textContent = 'アプリをインストール';
            installBtn.className = 'btn success';
            installBtn.style.marginBottom = '20px';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                }
            };
            document.querySelector('.main-content').prepend(installBtn);
        }
        
        // オフライン検知
        window.addEventListener('online', () => {
            document.body.classList.remove('offline');
            updateGPSStatus('オンラインになりました', false);
        });
        
        window.addEventListener('offline', () => {
            document.body.classList.add('offline');
            updateGPSStatus('オフラインです', true);
        });
        
        // GPS関連
        let watchId = null;
        let currentPosition = null;
        let gameData = null;
        
        function startGPSTracking() {
            if (!navigator.geolocation) {
                updateGPSStatus('GPS非対応のデバイスです', true);
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    currentPosition = position;
                    updateGPSStatus(
                        `📍 位置情報取得済み (精度: ${Math.round(position.coords.accuracy)}m)`,
                        false
                    );
                    
                    if (gameData) {
                        checkEvidenceProximity(position);
                        updateDistanceDisplay(position);
                    }
                },
                error => {
                    console.error('GPS error:', error);
                    updateGPSStatus('GPS取得エラー: ' + error.message, true);
                },
                options
            );
        }
        
        function updateGPSStatus(message, isError) {
            const statusEl = document.getElementById('gps-status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'gps-status error' : 'gps-status';
        }
        
        // ゲーム関連
        async function startNewGame() {
            if (!currentPosition) {
                alert('GPS情報を取得中です。少々お待ちください。');
                return;
            }
            
            const difficulty = document.getElementById('difficulty').value;
            
            // ローディング表示
            document.getElementById('start-screen').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ミステリーを生成中...</p>
                </div>
            `;
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/game/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player_id: 'mobile-player',
                        location: {
                            lat: currentPosition.coords.latitude,
                            lng: currentPosition.coords.longitude
                        },
                        difficulty: difficulty
                    })
                });
                
                if (response.ok) {
                    gameData = await response.json();
                    localStorage.setItem('currentGame', JSON.stringify(gameData));
                    showGameScreen();
                } else {
                    throw new Error('ゲーム開始失敗');
                }
            } catch (error) {
                console.error('Game start error:', error);
                alert('ゲーム開始に失敗しました。オフラインの場合は、保存済みゲームをロードします。');
                loadOfflineGame();
            }
        }
        
        function showGameScreen() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // シナリオ情報表示（推理要素を強化）
            if (gameData.scenario) {
                const scenario = gameData.scenario;
                document.getElementById('scenario-content').innerHTML = `
                    <h4 style="color: #667eea; margin-bottom: 10px;">${scenario.title || '事件発生！'}</h4>
                    <p style="margin-bottom: 15px; line-height: 1.6;">${scenario.description || ''}</p>
                    
                    ${scenario.incident_time || scenario.discovery_time ? `
                    <div style="background: #FFEBEE; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>⏰ 時間情報:</strong><br>
                        ${scenario.incident_time ? `<small>事件発生: ${scenario.incident_time}</small><br>` : ''}
                        ${scenario.discovery_time ? `<small>発見時刻: ${scenario.discovery_time}</small>` : ''}
                    </div>
                    ` : ''}
                    
                    ${scenario.victim ? `
                    <div style="background: #F5F5F5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>💀 被害者:</strong> ${scenario.victim.name} (${scenario.victim.age}歳)<br>
                        <small>${scenario.victim.occupation}</small><br>
                        ${scenario.victim.last_seen ? `<small style="color: #666;">最終目撃: ${scenario.victim.last_seen}</small>` : ''}
                    </div>
                    ` : ''}
                    
                    ${scenario.suspects && scenario.suspects.length > 0 ? `
                    <div style="background: #FFF3E0; padding: 10px; border-radius: 8px;">
                        <strong>👥 容疑者:</strong> ${scenario.suspects.length}名<br>
                        <small style="color: #666;">${scenario.suspects.map(s => s.name).join(', ')}</small>
                    </div>
                    ` : ''}
                    
                    <button class="btn" onclick="toggleScenarioDetails()" style="margin-top: 15px; width: 100%;">
                        容疑者の詳細を見る
                    </button>
                    
                    <div id="scenario-details" style="display: none; margin-top: 15px;">
                        ${scenario.suspects ? scenario.suspects.map(suspect => `
                            <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 3px solid #667eea;">
                                <strong>${suspect.name}</strong> (${suspect.age}歳) - ${suspect.occupation}<br>
                                <small>関係: ${suspect.relationship}</small><br>
                                ${suspect.alibi ? `<small style="color: #1976D2;">📍 アリバイ: ${suspect.alibi}</small><br>` : ''}
                                ${suspect.motive ? `<small style="color: #D32F2F;">💭 動機: ${suspect.motive}</small><br>` : ''}
                                ${suspect.suspicious_point ? `<small style="color: #F57C00;">⚠️ 不審な点: ${suspect.suspicious_point}</small>` : ''}
                            </div>
                        `).join('') : ''}
                    </div>
                    
                    ${scenario.timeline && scenario.timeline.length > 0 ? `
                    <button class="btn" onclick="toggleTimeline()" style="margin-top: 10px; width: 100%;">
                        タイムラインを見る
                    </button>
                    
                    <div id="timeline-details" style="display: none; margin-top: 15px; background: #E3F2FD; padding: 15px; border-radius: 8px;">
                        <strong>📅 事件の時系列:</strong><br>
                        ${scenario.timeline.map(event => `
                            <small style="display: block; margin: 5px 0; padding-left: 20px;">• ${event}</small>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
            }
            
            // 証拠リスト表示
            const evidenceList = document.getElementById('evidence-list');
            evidenceList.innerHTML = gameData.evidence.map(ev => `
                <li class="evidence-item" id="evidence-${ev.evidence_id}">
                    <div>
                        <strong>${ev.name}</strong><br>
                        <small>📍 ${ev.poi_name}</small>
                    </div>
                    <span id="distance-${ev.evidence_id}">--m</span>
                </li>
            `).join('');
            
            // マップ初期化（簡易版）
            initMap();
            
            // GPS情報があれば距離を更新
            if (currentPosition) {
                updateDistanceDisplay(currentPosition);
            }
        }
        
        function initMap() {
            // 実際にはGoogle Maps APIやLeafletを使用
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = `
                <div style="padding: 20px; text-align: center; background: #E3F2FD;">
                    <h3>🗺️ マップ</h3>
                    <p>現在地と証拠の位置を表示</p>
                    <p style="margin-top: 10px;">
                        緯度: ${currentPosition.coords.latitude.toFixed(4)}<br>
                        経度: ${currentPosition.coords.longitude.toFixed(4)}
                    </p>
                </div>
            `;
        }
        
        async function checkNearbyEvidence() {
            if (!currentPosition || !gameData) {
                alert('ゲームデータまたはGPS情報がありません');
                return;
            }
            
            // 各証拠との距離を計算
            for (const evidence of gameData.evidence) {
                const distance = calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    evidence.location.lat,
                    evidence.location.lng
                );
                
                document.getElementById(`distance-${evidence.evidence_id}`).textContent = `${Math.round(distance)}m`;
                
                // 50m以内なら発見可能
                if (distance <= 50) {
                    discoverEvidence(evidence);
                }
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球の半径（メートル）
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        async function discoverEvidence(evidence) {
            const evidenceItem = document.getElementById(`evidence-${evidence.evidence_id}`);
            if (evidenceItem.classList.contains('discovered')) {
                return; // 既に発見済み
            }
            
            // 発見通知
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // 詳細な証拠情報を表示
            const evidenceDetails = `
🎉 証拠を発見！

📍 場所: ${evidence.poi_name}
🔍 証拠: ${evidence.name}

📝 詳細:
${evidence.description || '詳細な分析が必要です。'}

💡 ヒント:
${evidence.hint || 'この証拠の意味を考えてみましょう。'}

重要度: ${evidence.importance === 'critical' ? '⭐⭐⭐ 重要' : '⭐⭐ 普通'}
            `;
            
            alert(evidenceDetails);
            evidenceItem.classList.add('discovered');
            
            // サーバーに発見を報告
            try {
                await fetch('http://localhost:8080/api/v1/evidence/discover', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        game_id: gameData.game_id,
                        player_id: 'mobile-player',
                        current_location: {
                            lat: currentPosition.coords.latitude,
                            lng: currentPosition.coords.longitude
                        },
                        evidence_id: evidence.evidence_id
                    })
                });
            } catch (error) {
                console.error('Evidence discovery error:', error);
                // オフラインでも発見を記録
                saveOfflineDiscovery(evidence.evidence_id);
            }
            
            // すべての証拠を発見したか確認
            checkAllEvidenceFound();
        }
        
        function checkAllEvidenceFound() {
            const allEvidence = document.querySelectorAll('.evidence-item');
            const discoveredEvidence = document.querySelectorAll('.evidence-item.discovered');
            
            if (allEvidence.length === discoveredEvidence.length) {
                alert('🎉 すべての証拠を発見しました！\n推理フェーズに進みます。');
                showDeductionPhase();
            }
        }
        
        async function showDeductionPhase() {
            // 推理フェーズのUIを表示
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('deduction-screen').style.display = 'block';
            
            // 容疑者情報を取得
            const suspects = gameData.scenario.suspects || [];
            let questionsRemaining = 10;
            
            document.getElementById('deduction-screen').innerHTML = `
                <div class="card">
                    <h2>🕵️ 推理フェーズ</h2>
                    <p>証拠を集め終わりました！容疑者に質問して真犯人を見つけ出しましょう。</p>
                    <p style="color: #666; font-size: 0.9em;">残り質問回数: <span id="questions-remaining">${questionsRemaining}</span>回</p>
                </div>
                
                <div class="card">
                    <h3>👥 容疑者リスト</h3>
                    <div id="suspects-list">
                        ${suspects.map(suspect => `
                            <div class="suspect-card" onclick="selectSuspect('${suspect.name}')">
                                <h4>${suspect.name} (${suspect.age}歳)</h4>
                                <p><strong>職業:</strong> ${suspect.occupation}</p>
                                <p><strong>関係:</strong> ${suspect.relationship}</p>
                                <p><strong>アリバイ:</strong> ${suspect.alibi}</p>
                                <p><strong>動機:</strong> ${suspect.motive}</p>
                                ${suspect.suspicious_point ? `<p style="color: #F57C00;"><strong>疑問点:</strong> ${suspect.suspicious_point}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="card" id="question-section" style="display: none;">
                    <h3>🔍 容疑者への質問</h3>
                    <p><strong>選択中:</strong> <span id="selected-suspect"></span></p>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">質問タイプ:</label>
                        <select id="question-type" style="width: 100%; padding: 10px; margin-top: 5px;">
                            <option value="alibi">アリバイについて詳しく</option>
                            <option value="motive">動機について</option>
                            <option value="relationship">被害者との関係</option>
                            <option value="witness">他の人について</option>
                            <option value="behavior">事件当日の行動</option>
                            <option value="evidence">証拠について</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="askSuspectQuestion()" style="width: 100%;">
                        質問する
                    </button>
                </div>
                
                <div class="card">
                    <h3>💬 質問履歴</h3>
                    <div id="conversation-log" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #666; font-style: italic;">まだ質問していません</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>🎯 犯人を特定</h3>
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">真犯人は誰ですか？</label>
                        <select id="culprit-guess" style="width: 100%; padding: 10px; margin-top: 5px;">
                            <option value="">選択してください...</option>
                            ${suspects.map(suspect => `
                                <option value="${suspect.name}">${suspect.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">推理の根拠を説明してください:</label>
                        <textarea id="deduction-reasoning" style="width: 100%; height: 100px; padding: 10px; margin-top: 5px;" 
                            placeholder="証拠と質問から得た情報を基に、なぜこの人が犯人だと思うかを説明してください"></textarea>
                    </div>
                    
                    <button class="btn success" onclick="submitFinalDeduction()" style="width: 100%;">
                        推理を提出する
                    </button>
                </div>
                
                <div id="deduction-result" style="display: none;">
                    <!-- 結果表示エリア -->
                </div>
            `;
        }
        
        function showScreen(screen) {
            // ナビゲーション処理
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function loadOfflineGame() {
            const savedGame = localStorage.getItem('currentGame');
            if (savedGame) {
                gameData = JSON.parse(savedGame);
                showGameScreen();
            }
        }
        
        function saveOfflineDiscovery(evidenceId) {
            const discoveries = JSON.parse(localStorage.getItem('discoveries') || '[]');
            discoveries.push({
                evidence_id: evidenceId,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('discoveries', JSON.stringify(discoveries));
        }
        
        function checkEvidenceProximity(position) {
            // 自動的に近くの証拠をチェック
            if (gameData && gameData.evidence) {
                for (const evidence of gameData.evidence) {
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    );
                    
                    if (distance <= 30) {
                        // 30m以内になったら通知
                        showProximityNotification(evidence, distance);
                    }
                }
            }
        }
        
        function updateDistanceDisplay(position) {
            // 各証拠との距離を表示更新
            if (gameData && gameData.evidence) {
                for (const evidence of gameData.evidence) {
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        evidence.location.lat,
                        evidence.location.lng
                    );
                    
                    const distanceElement = document.getElementById(`distance-${evidence.evidence_id}`);
                    if (distanceElement) {
                        distanceElement.textContent = `${Math.round(distance)}m`;
                    }
                }
            }
        }
        
        function showProximityNotification(evidence, distance) {
            if (Notification.permission === 'granted') {
                new Notification('証拠が近くにあります！', {
                    body: `${evidence.name}まで約${Math.round(distance)}m`,
                    icon: '/static/icons/icon-192x192.png',
                    vibrate: [200, 100, 200]
                });
            }
        }
        
        function toggleScenarioDetails() {
            const details = document.getElementById('scenario-details');
            const button = event.target;
            if (details.style.display === 'none') {
                details.style.display = 'block';
                button.textContent = '容疑者の詳細を隠す';
            } else {
                details.style.display = 'none';
                button.textContent = '容疑者の詳細を見る';
            }
        }
        
        function toggleTimeline() {
            const timeline = document.getElementById('timeline-details');
            const button = event.target;
            if (timeline.style.display === 'none') {
                timeline.style.display = 'block';
                button.textContent = 'タイムラインを隠す';
            } else {
                timeline.style.display = 'none';
                button.textContent = 'タイムラインを見る';
            }
        }
        
        // 推理フェーズの機能
        let selectedSuspectName = null;
        let questionsAsked = 0;
        const maxQuestions = 10;
        
        function selectSuspect(suspectName) {
            selectedSuspectName = suspectName;
            document.getElementById('selected-suspect').textContent = suspectName;
            document.getElementById('question-section').style.display = 'block';
            
            // 選択された容疑者をハイライト
            document.querySelectorAll('.suspect-card').forEach(card => {
                card.style.border = '2px solid #E0E0E0';
            });
            event.target.style.border = '2px solid #667eea';
        }
        
        async function askSuspectQuestion() {
            if (!selectedSuspectName) {
                alert('容疑者を選択してください');
                return;
            }
            
            if (questionsAsked >= maxQuestions) {
                alert('質問回数の上限に達しました');
                return;
            }
            
            const questionType = document.getElementById('question-type').value;
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/deduction/question', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        game_id: gameData.game_id,
                        suspect_name: selectedSuspectName,
                        question_type: questionType
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayQuestionResult(result);
                    questionsAsked++;
                    document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
                } else {
                    // バックエンドAPIがない場合の簡易回答生成
                    const mockAnswer = generateMockAnswer(selectedSuspectName, questionType);
                    displayQuestionResult(mockAnswer);
                    questionsAsked++;
                    document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
                }
            } catch (error) {
                console.error('Question error:', error);
                // エラー時も簡易回答を生成
                const mockAnswer = generateMockAnswer(selectedSuspectName, questionType);
                displayQuestionResult(mockAnswer);
                questionsAsked++;
                document.getElementById('questions-remaining').textContent = maxQuestions - questionsAsked;
            }
        }
        
        function generateMockAnswer(suspectName, questionType) {
            const suspect = gameData.scenario.suspects.find(s => s.name === suspectName);
            const isCulprit = suspect.name === gameData.scenario.culprit;
            
            let answer = '';
            let reaction = '';
            
            switch (questionType) {
                case 'alibi':
                    answer = suspect.alibi || '特にアリバイはありません。';
                    reaction = isCulprit ? '少し緊張した様子で答える。' : '落ち着いて答える。';
                    break;
                case 'motive':
                    answer = suspect.motive ? `${suspect.motive}ですが、殺害するほどではありません。` : '特に動機はありません。';
                    reaction = isCulprit ? '表情が強張る。' : '率直に答える。';
                    break;
                case 'relationship':
                    answer = `被害者とは${suspect.relationship}の関係でした。`;
                    reaction = isCulprit ? '目を逸らしがちになる。' : '普通に答える。';
                    break;
                case 'behavior':
                    answer = isCulprit && suspect.contradiction ? 
                        suspect.contradiction : 
                        'いつも通りの日常を過ごしていました。';
                    reaction = isCulprit ? '詳細を避けたがる。' : 'はっきりと答える。';
                    break;
                default:
                    answer = '特にお答えできることはありません。';
                    reaction = '困った表情を見せる。';
            }
            
            return {
                question: `${questionType}について質問しました`,
                answer: answer,
                reaction: reaction,
                suspect_name: suspectName,
                hint_revealed: isCulprit && Math.random() > 0.7 ? suspect.contradiction || '何かを隠している様子' : null
            };
        }
        
        function displayQuestionResult(result) {
            const logDiv = document.getElementById('conversation-log');
            if (logDiv.innerHTML.includes('まだ質問していません')) {
                logDiv.innerHTML = '';
            }
            
            const conversationHTML = `
                <div style="background: #E8F5E9; padding: 10px; margin: 10px 0; border-radius: 8px;">
                    <p><strong>🔍 質問:</strong> ${result.suspect_name}に${result.question}</p>
                </div>
                <div style="background: #FFF3E0; padding: 10px; margin: 10px 0; border-radius: 8px;">
                    <p><strong>👤 ${result.suspect_name}:</strong></p>
                    <p>${result.answer}</p>
                    <p style="font-style: italic; color: #666; margin-top: 8px;">${result.reaction}</p>
                    ${result.hint_revealed ? `<p style="color: #2E7D32; margin-top: 8px;">💡 気づいた点: ${result.hint_revealed}</p>` : ''}
                </div>
            `;
            logDiv.innerHTML = conversationHTML + logDiv.innerHTML;
        }
        
        async function submitFinalDeduction() {
            const culpritGuess = document.getElementById('culprit-guess').value;
            const reasoning = document.getElementById('deduction-reasoning').value;
            
            if (!culpritGuess || !reasoning) {
                alert('犯人の選択と推理の根拠を両方入力してください');
                return;
            }
            
            // 正解判定
            const isCorrect = culpritGuess === gameData.scenario.culprit;
            const trueCulprit = gameData.scenario.culprit;
            const trueMotive = gameData.scenario.true_motive;
            
            // 結果表示
            document.getElementById('deduction-result').style.display = 'block';
            document.getElementById('deduction-result').innerHTML = `
                <div class="card" style="background: ${isCorrect ? '#E8F5E9' : '#FFEBEE'};">
                    <h3 style="color: ${isCorrect ? '#2E7D32' : '#C62828'};">
                        ${isCorrect ? '🎉 正解！' : '😔 不正解...'}
                    </h3>
                    
                    <div style="margin: 20px 0;">
                        <p><strong>あなたの推理:</strong> ${culpritGuess}</p>
                        <p><strong>正解:</strong> ${trueCulprit}</p>
                        <p style="margin-top: 10px;"><strong>あなたの推理根拠:</strong></p>
                        <p style="background: #F5F5F5; padding: 10px; border-radius: 5px;">${reasoning}</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4>📖 事件の真相</h4>
                        <p><strong>真犯人:</strong> ${trueCulprit}</p>
                        <p><strong>真の動機:</strong> ${trueMotive}</p>
                        <p><strong>犯行方法:</strong> ${gameData.scenario.method}</p>
                        ${gameData.scenario.trick ? `<p><strong>トリック:</strong> ${gameData.scenario.trick}</p>` : ''}
                    </div>
                    
                    <div style="background: #E3F2FD; padding: 15px; border-radius: 8px;">
                        <h4>🏆 結果</h4>
                        <p>質問回数: ${questionsAsked}/${maxQuestions}回使用</p>
                        <p>証拠発見: ${document.querySelectorAll('.evidence-item.discovered').length}/${document.querySelectorAll('.evidence-item').length}個</p>
                        ${isCorrect ? 
                            `<p style="color: #2E7D32; font-weight: bold;">🎊 事件解決！素晴らしい推理でした！</p>` : 
                            `<p style="color: #D32F2F;">もう一度挑戦してみましょう。証拠と証言をよく検証してください。</p>`
                        }
                    </div>
                    
                    <button class="btn" onclick="location.reload()" style="margin-top: 20px; width: 100%;">
                        新しいゲームを開始
                    </button>
                </div>
            `;
            
            // 結果にスクロール
            document.getElementById('deduction-result').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 初期化
        window.addEventListener('load', () => {
            startGPSTracking();
            
            // 通知許可リクエスト
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // 保存済みゲームがあるか確認
            const savedGame = localStorage.getItem('currentGame');
            if (savedGame) {
                if (confirm('前回のゲームを続けますか？')) {
                    loadOfflineGame();
                }
            }
        });
    </script>
</body>
</html>